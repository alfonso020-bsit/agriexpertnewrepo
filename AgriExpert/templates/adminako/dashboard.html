{% extends 'adminako/base_admin.html' %}
{% load static %}

{% block content %}

<div class="container mt-5">
    <h2 class="text-center mb-4">
        <span>Magandang Araw, <strong>{{ request.user.username }}</strong>! ðŸŒ¾</span><br>
        <span id="flipping-text" class="flipping-text">Masaganang Ani sa VictoreÃ±os!</span>
    </h2>

    <!-- Main Count Cards -->
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-seedling fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Magsasaka</h5>
                <h1 class="display-4 fw-bold">{{ farmer_count }}</h1>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-user-tie fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Eksperto</h5>
                <h1 class="display-4 fw-bold">{{ expert_count }}</h1>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-warning shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Konsultasyon</h5>
                <h1 class="display-4 fw-bold">{{ consultation_count }}</h1>
            </div>
        </div>

        <!-- Adding new count card for total posts -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-info shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-newspaper fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Mga Post</h5>
                <h1 class="display-4 fw-bold">{{ post_engagement_data.expert_posts|add:post_engagement_data.farmer_posts }}</h1>
            </div>
        </div>
    </div>

    <!-- Adding prediction analytics cards -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-bug text-success fa-2x mb-2"></i>
                    <h6 class="fw-bold">Pest Detections</h6>
                    <h2 class="text-success">{{ pest_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-disease text-danger fa-2x mb-2"></i>
                    <h6 class="fw-bold">Disease Detections</h6>
                    <h2 class="text-danger">{{ disease_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line text-primary fa-2x mb-2"></i>
                    <h6 class="fw-bold">Total Detections</h6>
                    <h2 class="text-primary">{{ pest_count|add:disease_count }}</h2>
                </div>
            </div>
        </div>
    </div>

     <!-- Enhanced modal for showing prediction list with farmer details -->
    <div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="predictionModalLabel">
                        <i class="fas fa-calendar-day me-2"></i>
                        Predictions for <span id="modalDate" class="text-primary"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                     <!-- Pest Predictions -->
                    <div id="pestPredictionsSection" style="display: none;">
                        <h6 class="text-success fw-bold mb-3 border-bottom pb-2">
                            <i class="fas fa-bug me-2"></i>Pest Detections (<span id="pestCount"></span>)
                        </h6>
                        <div id="pestPredictionsList" class="mb-4"></div>
                    </div>
                    
                     <!-- Disease Predictions -->
                    <div id="diseasePredictionsSection" style="display: none;">
                        <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">
                            <i class="fas fa-virus me-2"></i>Diseasee Detections (<span id="diseaseCount"></span>)
                        </h6>
                        <div id="diseasePredictionsList"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

     <!-- New detailed prediction modal -->
    <div class="modal fade" id="predictionDetailModal" tabindex="-1" aria-labelledby="predictionDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="predictionDetailModalLabel">
                        <i class="fas fa-info-circle me-2"></i>Detection Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                         <!-- Image Section -->
                        <div class="col-md-5 mb-3">
                            <div class="prediction-image-container">
                                <img id="detailImage" src="/placeholder.svg" alt="Prediction image" class="img-fluid rounded shadow-sm" style="width: 100%; height: auto; max-height: 300px; object-fit: cover;">
                            </div>
                        </div>
                        
                         <!-- Details Section -->
                        <div class="col-md-7">
                             <!-- Prediction Class -->
                            <div class="mb-3">
                                <h4 id="detailClass" class="text-primary mb-2"></h4>
                                <span id="detailTypeBadge" class="badge"></span>
                                <span id="detailNewBadge" class="badge bg-danger ms-1" style="display: none;">NEW</span>
                            </div>
                            
                             <!-- Confidence Score -->
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">Confidence Score</label>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 25px;">
                                        <div id="detailConfidenceBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <span id="detailConfidenceText" class="fw-bold"></span>
                                </div>
                            </div>
                            
                             <!-- Timestamp -->
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">
                                    <i class="fas fa-clock me-1"></i>Timestamp
                                </label>
                                <p id="detailTime" class="mb-0"></p>
                            </div>
                            
                             <!-- Farmer Information -->
                            <div class="card bg-light border-0 mt-3">
                                <div class="card-body">
                                    <h6 class="card-title fw-bold mb-3">
                                        <i class="fas fa-user-circle me-2"></i>Farmer Information
                                    </h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Name</small>
                                            <strong id="detailFarmerName"></strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Contact</small>
                                            <strong id="detailFarmerContact"></strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Barangay</small>
                                            <strong id="detailFarmerBarangay"></strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Farm Size</small>
                                            <strong id="detailFarmerFarmSize"></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-arrow-left me-1"></i>Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Section -->
    <div class="col-12 my-5">
        <div class="card shadow rounded-4 p-3">
            <h6 class="text-center fw-bold mb-3">Kalendaryo ng Deteksyon</h6>
            <div id="calendar" style="height: 600px; width: 100%;"></div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="row g-4 justify-content-center">
        <!-- Comparison Chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Paghahambing ng Bilang</h6>
                <div style="height: 250px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Solved vs Unsolved -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Nalutas vs Hindi Nalutas na Konsultasyon</h6>
                <div style="height: 250px;">
                    <canvas id="consultationStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Consultation Type (Sakit vs Peste) -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3 h-100">
                <h6 class="text-center fw-bold mb-3">Nakasolusyunan na mga Konsultasyon: Sakit laban sa Peste</h6>
                <div class="d-flex justify-content-center align-items-center">
                    <canvas id="consultationTypeChart" style="width:100%; height:auto;"></canvas>
                </div>
            </div>
        </div>

        <!-- Barangay Consultation Pie Chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3 h-100">
                <h6 class="text-center fw-bold mb-3">Mga Rekord ng Konsultasyon kada Barangay</h6>
                <div class="d-flex justify-content-center align-items-center">
                    <canvas id="barangayConsultationChart" style="width:100%; height:auto;"></canvas>
                </div>
            </div>
        </div>

        <!-- Adding prediction confidence distribution chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Detection Confidence Distribution</h6>
                <div style="height: 250px;">
                    <canvas id="confidenceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Adding top predictions chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Top 5 Pinaka-Common na Detections</h6>
                <div style="height: 250px;">
                    <canvas id="topPredictionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Adding post engagement chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Post Engagement Metrics</h6>
                <div style="height: 250px;">
                    <canvas id="postEngagementChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Adding farm size distribution chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Farm Size Distribution</h6>
                <div style="height: 250px;">
                    <canvas id="farmSizeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Adding user distribution by barangay chart -->
        <div class="col-12">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">User Distribution per Barangay</h6>
                <div style="overflow-x: auto;">
                    <div style="min-width: 600px; height: 300px;">
                        <canvas id="userBarangayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Consultation Trends -->
        <div class="col-12">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Mga Trend ng Buwanang Konsultasyon</h6>
                <div style="overflow-x: auto;">
                    <div style="min-width: 600px; height: 250px;">
                        <canvas id="monthlyConsultationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Adding user growth trends chart -->
        <div class="col-12">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">User Growth Trends (Last 12 Months)</h6>
                <div style="overflow-x: auto;">
                    <div style="min-width: 600px; height: 300px;">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Script Tags for Data -->
    {{ barangay_data|json_script:"barangay-data" }}
    {{ consultation_trends_data|json_script:"trend-data" }}
    {{ top_predictions|json_script:"top-predictions-data" }}
    {{ confidence_distribution|json_script:"confidence-data" }}
    {{ user_growth_data|json_script:"user-growth-data" }}
    {{ post_engagement_data|json_script:"post-engagement-data" }}
    {{ farm_sizes|json_script:"farm-sizes-data" }}
    {{ farmer_barangay_data|json_script:"farmer-barangay-data" }}
    {{ expert_barangay_data|json_script:"expert-barangay-data" }}

    <!-- FullCalendar CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Function to show detailed prediction modal
            function showPredictionDetail(prediction) {
                // Set image
                document.getElementById('detailImage').src = prediction.image_url || '/placeholder.svg?height=300&width=300';
                
                // Set class name
                document.getElementById('detailClass').textContent = prediction.class;
                
                // Set type badge
                const typeBadge = document.getElementById('detailTypeBadge');
                if (prediction.type === 'pest') {
                    typeBadge.textContent = 'Peste';
                    typeBadge.className = 'badge bg-success';
                } else {
                    typeBadge.textContent = 'Sakit';
                    typeBadge.className = 'badge bg-danger';
                }
                
                // Show/hide NEW badge
                const newBadge = document.getElementById('detailNewBadge');
                newBadge.style.display = prediction.is_new ? 'inline-block' : 'none';
                
                // Set confidence with color coding
                const confidence = prediction.confidence;
                const confidenceBar = document.getElementById('detailConfidenceBar');
                const confidenceText = document.getElementById('detailConfidenceText');
                
                confidenceBar.style.width = confidence + '%';
                confidenceText.textContent = confidence.toFixed(1) + '%';
                
                if (confidence >= 80) {
                    confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-success';
                } else if (confidence >= 50) {
                    confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
                } else {
                    confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-danger';
                }
                
                // Set timestamp
                document.getElementById('detailTime').textContent = prediction.time;
                
                // Set farmer information
                document.getElementById('detailFarmerName').textContent = prediction.farmer_name || 'N/A';
                document.getElementById('detailFarmerContact').textContent = prediction.farmer_contact || 'N/A';
                document.getElementById('detailFarmerBarangay').textContent = prediction.farmer_barangay || 'N/A';
                document.getElementById('detailFarmerFarmSize').textContent = prediction.farmer_farm_size || 'N/A';
                
                // Show the detail modal
                const detailModal = new bootstrap.Modal(document.getElementById('predictionDetailModal'));
                detailModal.show();
            }

            // Calendar initialization
            try {
                let eventsData = [];
                try {
                    eventsData = {{ calendar_events_json|safe }};
                    console.log("Calendar events loaded:", eventsData);
                } catch (error) {
                    console.error("Failed to parse calendar events:", error);
                    eventsData = [];
                }
                
                const calendarEl = document.getElementById('calendar');
                
                if (!calendarEl) {
                    console.error("Calendar element not found!");
                    return;
                }
                
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    events: eventsData,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    height: 600,
                    eventDidMount: function(info) {
                        // Add "new" indicator dot if there are new predictions
                        if (info.event.extendedProps.has_new) {
                            const dotEl = document.createElement('span');
                            dotEl.innerHTML = ' <span style="display: inline-block; width: 8px; height: 8px; background-color: #ff0000; border-radius: 50%; margin-left: 4px; animation: pulse 1.5s infinite;"></span>';
                            info.el.querySelector('.fc-event-title').appendChild(dotEl);
                        }
                        
                        info.el.style.cursor = 'pointer';
                    },
                    eventClick: function(info) {
                        const props = info.event.extendedProps;
                        const eventDate = new Date(info.event.start);
                        const formattedDate = eventDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        
                        document.getElementById('modalDate').textContent = formattedDate;
                        
                        // Show pest predictions
                        if (props.pest_count > 0) {
                            document.getElementById('pestPredictionsSection').style.display = 'block';
                            document.getElementById('pestCount').textContent = props.pest_count;
                            
                            const sortedPest = props.pest_predictions.sort((a, b) => b.id - a.id);
                            
                            let pestHTML = '';
                            sortedPest.forEach(pred => {
                                const newBadge = pred.is_new ? '<span class="badge bg-danger ms-2 pulse-badge">NEW</span>' : '';
                                const confidenceColor = pred.confidence >= 80 ? 'success' : pred.confidence >= 50 ? 'warning' : 'danger';
                                
                                pestHTML += `
                                    <div class="card mb-3 prediction-card shadow-sm hover-shadow" style="cursor: pointer;" onclick='showPredictionDetail(${JSON.stringify(pred).replace(/'/g, "&#39;")})'>
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                ${pred.image_url ? `
                                                    <div class="col-md-3">
                                                        <img src="${pred.image_url}" class="img-fluid rounded shadow-sm" alt="Prediction image" style="height: 100px; width: 100%; object-fit: cover;">
                                                    </div>
                                                ` : ''}
                                                <div class="${pred.image_url ? 'col-md-6' : 'col-md-9'}">
                                                    <h6 class="mb-2">
                                                        <i class="fas fa-bug text-success me-2"></i>${pred.class} ${newBadge}
                                                    </h6>
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block mb-1">Confidence Score</small>
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-${confidenceColor}" role="progressbar" style="width: ${pred.confidence}%" aria-valuenow="${pred.confidence}" aria-valuemin="0" aria-valuemax="100">
                                                                ${pred.confidence.toFixed(1)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="mb-1 text-muted small">
                                                        <i class="fas fa-clock me-1"></i>${pred.time}
                                                    </p>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="farmer-info-preview p-2 bg-light rounded">
                                                        <small class="text-muted d-block mb-1"><i class="fas fa-user me-1"></i>Farmer</small>
                                                        <strong class="d-block small">${pred.farmer_name || 'N/A'}</strong>
                                                        <small class="text-muted d-block mt-1">${pred.farmer_barangay || 'N/A'}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            document.getElementById('pestPredictionsList').innerHTML = pestHTML;
                        } else {
                            document.getElementById('pestPredictionsSection').style.display = 'none';
                        }
                        
                        // Show disease predictions
                        if (props.disease_count > 0) {
                            document.getElementById('diseasePredictionsSection').style.display = 'block';
                            document.getElementById('diseaseCount').textContent = props.disease_count;
                            
                            const sortedDisease = props.disease_predictions.sort((a, b) => b.id - a.id);
                            
                            let diseaseHTML = '';
                            sortedDisease.forEach(pred => {
                                const newBadge = pred.is_new ? '<span class="badge bg-danger ms-2 pulse-badge">NEW</span>' : '';
                                const confidenceColor = pred.confidence >= 80 ? 'success' : pred.confidence >= 50 ? 'warning' : 'danger';
                                
                                diseaseHTML += `
                                    <div class="card mb-3 prediction-card shadow-sm hover-shadow" style="cursor: pointer;" onclick='showPredictionDetail(${JSON.stringify(pred).replace(/'/g, "&#39;")})'>
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                ${pred.image_url ? `
                                                    <div class="col-md-3">
                                                        <img src="${pred.image_url}" class="img-fluid rounded shadow-sm" alt="Prediction image" style="height: 100px; width: 100%; object-fit: cover;">
                                                    </div>
                                                ` : ''}
                                                <div class="${pred.image_url ? 'col-md-6' : 'col-md-9'}">
                                                    <h6 class="mb-2">
                                                        <i class="fas fa-virus text-danger me-2"></i>${pred.class} ${newBadge}
                                                    </h6>
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block mb-1">Confidence Score</small>
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-${confidenceColor}" role="progressbar" style="width: ${pred.confidence}%" aria-valuenow="${pred.confidence}" aria-valuemin="0" aria-valuemax="100">
                                                                ${pred.confidence.toFixed(1)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="mb-1 text-muted small">
                                                        <i class="fas fa-clock me-1"></i>${pred.time}
                                                    </p>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="farmer-info-preview p-2 bg-light rounded">
                                                        <small class="text-muted d-block mb-1"><i class="fas fa-user me-1"></i>Farmer</small>
                                                        <strong class="d-block small">${pred.farmer_name || 'N/A'}</strong>
                                                        <small class="text-muted d-block mt-1">${pred.farmer_barangay || 'N/A'}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            document.getElementById('diseasePredictionsList').innerHTML = diseaseHTML;
                        } else {
                            document.getElementById('diseasePredictionsSection').style.display = 'none';
                        }
                        
                        const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
                        modal.show();
                    }
                });
                
                calendar.render();
                console.log("Calendar render method called");
                
                // Make showPredictionDetail available globally
                window.showPredictionDetail = showPredictionDetail;
                
            } catch (err) {
                console.error("Error in calendar initialization:", err);
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    calendarEl.innerHTML = '<div class="alert alert-danger">Failed to load calendar: ' + err.message + '</div>';
                }
            }

            // Comparison Chart
            new Chart(document.getElementById("comparisonChart"), {
                type: "bar",
                data: {
                    labels: ["Magsasaka", "Eksperto", "Konsultasyon"],
                    datasets: [
                        {
                            label: "Magsasaka",
                            data: [{{ farmer_count }}, 0, 0],
                            backgroundColor: "#28a745"
                        },
                        {
                            label: "Eksperto - Approved",
                            data: [0, {{ expert_approved }}, 0],
                            backgroundColor: "#007bff"
                        },
                        {
                            label: "Eksperto - Pending",
                            data: [0, {{ expert_pending }}, 0],
                            backgroundColor: "#ffc107"
                        },
                        {
                            label: "Eksperto - Rejected",
                            data: [0, {{ expert_rejected }}, 0],
                            backgroundColor: "#dc3545"
                        },
                        {
                            label: "Konsultasyon",
                            data: [0, 0, {{ consultation_count }}],
                            backgroundColor: "#fd7e14"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: { legend: { position: "top" } }
                }
            });

            // Solved vs Unsolved
            new Chart(document.getElementById("consultationStatusChart"), {
                type: "bar",
                data: {
                    labels: ["Solved", "Unsolved"],
                    datasets: [{
                        label: "Consultation Cases",
                        data: [{{ consultation_solved }}, {{ consultation_unsolved }}],
                        backgroundColor: ["#28a745", "#dc3545"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Consultation Type Chart
            new Chart(document.getElementById("consultationTypeChart"), {
                type: "pie",
                data: {
                    labels: ["Sakit", "Peste"],
                    datasets: [{
                        data: [
                            {{ consultation_type_chart_data.solved_sakit|default:0 }},
                            {{ consultation_type_chart_data.solved_peste|default:0 }}
                        ],
                        backgroundColor: ["#f94144", "#43aa8b"]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Barangay Distribution
            const barangayData = JSON.parse(document.getElementById("barangay-data").textContent);
            new Chart(document.getElementById("barangayConsultationChart"), {
                type: "pie",
                data: {
                    labels: Object.keys(barangayData),
                    datasets: [{
                        data: Object.values(barangayData),
                        backgroundColor: [
                            "#007bff", "#ffc107", "#28a745", "#dc3545", "#17a2b8",
                            "#6610f2", "#fd7e14", "#6f42c1", "#20c997", "#e83e8c"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Monthly Trend Chart
            const trendData = JSON.parse(document.getElementById("trend-data").textContent);
            new Chart(document.getElementById("monthlyConsultationChart"), {
                type: "line",
                data: {
                    labels: Object.keys(trendData),
                    datasets: [{
                        label: "Consultations per Month",
                        data: Object.values(trendData),
                        fill: false,
                        borderColor: "#007bff",
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const confidenceData = JSON.parse(document.getElementById("confidence-data").textContent);
            new Chart(document.getElementById("confidenceChart"), {
                type: "doughnut",
                data: {
                    labels: ["High (â‰¥80%)", "Medium (50-79%)", "Low (<50%)"],
                    datasets: [{
                        data: [confidenceData.high, confidenceData.medium, confidenceData.low],
                        backgroundColor: ["#28a745", "#ffc107", "#dc3545"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            const topPredictionsData = JSON.parse(document.getElementById("top-predictions-data").textContent);
            new Chart(document.getElementById("topPredictionsChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(topPredictionsData),
                    datasets: [{
                        label: "Frequency",
                        data: Object.values(topPredictionsData),
                        backgroundColor: "#17a2b8"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const postEngagementData = JSON.parse(document.getElementById("post-engagement-data").textContent);
            new Chart(document.getElementById("postEngagementChart"), {
                type: "bar",
                data: {
                    labels: ["Expert Posts", "Farmer Posts", "Total Upvotes", "Total Comments"],
                    datasets: [{
                        label: "Count",
                        data: [
                            postEngagementData.expert_posts,
                            postEngagementData.farmer_posts,
                            postEngagementData.total_upvotes,
                            postEngagementData.total_comments
                        ],
                        backgroundColor: ["#007bff", "#28a745", "#ffc107", "#dc3545"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const farmSizesData = JSON.parse(document.getElementById("farm-sizes-data").textContent);
            new Chart(document.getElementById("farmSizeChart"), {
                type: "pie",
                data: {
                    labels: ["Small (<1 ha)", "Medium (1-5 ha)", "Large (>5 ha)"],
                    datasets: [{
                        data: [farmSizesData.small, farmSizesData.medium, farmSizesData.large],
                        backgroundColor: ["#ffc107", "#28a745", "#007bff"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            const farmerBarangayData = JSON.parse(document.getElementById("farmer-barangay-data").textContent);
            const expertBarangayData = JSON.parse(document.getElementById("expert-barangay-data").textContent);
            
            const allBarangays = [...new Set([...Object.keys(farmerBarangayData), ...Object.keys(expertBarangayData)])];
            
            new Chart(document.getElementById("userBarangayChart"), {
                type: "bar",
                data: {
                    labels: allBarangays,
                    datasets: [
                        {
                            label: "Farmers",
                            data: allBarangays.map(b => farmerBarangayData[b] || 0),
                            backgroundColor: "#28a745"
                        },
                        {
                            label: "Experts",
                            data: allBarangays.map(b => expertBarangayData[b] || 0),
                            backgroundColor: "#007bff"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            const userGrowthData = JSON.parse(document.getElementById("user-growth-data").textContent);
            new Chart(document.getElementById("userGrowthChart"), {
                type: "line",
                data: {
                    labels: Object.keys(userGrowthData.farmers),
                    datasets: [
                        {
                            label: "Farmers",
                            data: Object.values(userGrowthData.farmers),
                            borderColor: "#28a745",
                            backgroundColor: "rgba(40, 167, 69, 0.1)",
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: "Experts",
                            data: Object.values(userGrowthData.experts),
                            borderColor: "#007bff",
                            backgroundColor: "rgba(0, 123, 255, 0.1)",
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        });
    </script>

    <!-- Enhanced styles for modals and animations -->
    <style>
        .flipping-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            display: inline-block;
            position: relative;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .pulse-badge {
            animation: pulse 1.5s infinite;
        }

        .prediction-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .prediction-card:hover {
            transform: translateY(-2px);
            border-left-color: #007bff;
        }

        .hover-shadow:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }

        .farmer-info-preview {
            transition: all 0.2s ease;
        }

        .prediction-card:hover .farmer-info-preview {
            background-color: #e3f2fd !important;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .prediction-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }

        .prediction-image-container img {
            transition: transform 0.3s ease;
        }

        .prediction-image-container:hover img {
            transform: scale(1.05);
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const phrases = [
                "Masaganang Ani sa VictoreÃ±os! ðŸŒ¾",
                "Malusog na Palay! ðŸŒ±",
                "Alamin ang Peste! ðŸ›",
                "Handa na ba ang Pananim mo? ðŸŒ¿",
                "Gabay sa Magsasaka! ðŸšœ"
            ];
            let index = 0;
            const flippingText = document.getElementById("flipping-text");

            setInterval(() => {
                index = (index + 1) % phrases.length;
                flippingText.style.opacity = 0;
                setTimeout(() => {
                    flippingText.innerText = phrases[index];
                    flippingText.style.opacity = 1;
                }, 500);
            }, 3000);
        });
    </script>
</div>
{% endblock %}


{% comment %} {% extends 'adminako/base_admin.html' %}
{% load static %} {% endcomment %}
{% comment %} {% extends 'adminako/base_admin.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">
        <span>Magandang Araw, <strong>{{ request.user.username }}</strong>! ðŸŒ¾</span>
        <br>
        <span id="flipping-text" class="flipping-text">Masaganang Ani sa VictoreÃ±os!</span>
    </h2>

    <div class="row justify-content-center">
        <!-- Farmers Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-seedling fa-3x mb-3"></i> <!-- ðŸŒ± Farmer Icon -->
                    <h5 class="card-title fw-bold text-uppercase">Magsasaka</h5>
                    <h1 class="display-4 fw-bold">{{ farmer_count }}</h1>
                </div>
            </div>
        </div>

        <!-- Experts Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-user-tie fa-3x mb-3"></i> <!-- ðŸ‘” Expert Icon -->
                    <h5 class="card-title fw-bold text-uppercase">Eksperto</h5>
                    <h1 class="display-4 fw-bold">{{ expert_count }}</h1>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<!-- Custom CSS for Flipping Text -->
<style>
    .flipping-text {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
        display: inline-block;
        position: relative;
        animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<!-- JavaScript for Flipping Text -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const phrases = [
            "Masaganang Ani sa VictoreÃ±os! ðŸŒ¾",
            "Malusog na Palay! ðŸŒ±",
            "Alamin ang Peste! ðŸ›",
            "Handa na ba ang Pananim mo? ðŸŒ¿",
            "Gabay sa Magsasaka! ðŸšœ"
        ];

        let index = 0;
        const flippingText = document.getElementById("flipping-text");

        setInterval(() => {
            index = (index + 1) % phrases.length;
            flippingText.style.opacity = 0; 
            setTimeout(() => {
                flippingText.innerText = phrases[index];
                flippingText.style.opacity = 1; 
            }, 500);
        }, 3000); // Change text every 3 seconds
    });
</script>
{% endblock %} {% endcomment %}

{% comment %} 
{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">
        <span>Magandang Araw, <strong>{{ request.user.username }}</strong>! ðŸŒ¾</span>
        <br>
        <span id="flipping-text" class="flipping-text">Masaganang Ani sa VictoreÃ±os!</span>
    </h2>

    <div class="row justify-content-center">
        <!-- Farmers Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-seedling fa-3x mb-3"></i> <!-- ðŸŒ± Farmer Icon -->
                    <h5 class="card-title fw-bold text-uppercase">Magsasaka</h5>
                    <h1 class="display-4 fw-bold">{{ farmer_count }}</h1>
                </div>
            </div>
        </div>

        <!-- Eksperto Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-user-tie fa-3x mb-3"></i> <!-- ðŸ‘” Expert Icon -->
                    <h5 class="card-title fw-bold text-uppercase">Eksperto</h5>
                    <h1 class="display-4 fw-bold">{{ expert_count }}</h1>  <!-- Ensure this variable is working -->
                </div>
            </div>
        </div>

    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-lg rounded-4 border-0 p-3">
                <div class="card-body">
                    <h6 class="card-title text-center fw-bold">Paghahambing ng Bilang</h6>
                    <div style="width: 100%; height: 250px;"> <!-- Fixed Size -->
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById("comparisonChart").getContext("2d");
    
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Magsasaka", "Eksperto"],
                    datasets: [
                        {
                            label: "Magsasaka",
                            data: [{{ farmer_count }}, 0],
                            backgroundColor: "#28a745"
                        },
                        {
                            label: "Eksperto - Approved",
                            data: [0, {{ expert_approved }}],
                            backgroundColor: "#007bff"
                        },
                        {
                            label: "Eksperto - Pending",
                            data: [0, {{ expert_pending }}],
                            backgroundColor: "#ffc107"
                        },
                        {
                            label: "Eksperto - Rejected",
                            data: [0, {{ expert_rejected }}],
                            backgroundColor: "#dc3545"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max({{ farmer_count }}, {{ expert_approved }}, {{ expert_pending }}, {{ expert_rejected }}) + 2,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { position: "top" }
                    }
                }
            });
        });
    </script>

<!-- Custom CSS for Flipping Text -->
<style>
    .flipping-text {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
        display: inline-block;
        position: relative;
        animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<!-- JavaScript for Flipping Text -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const phrases = [
            "Masaganang Ani sa VictoreÃ±os! ðŸŒ¾",
            "Malusog na Palay! ðŸŒ±",
            "Alamin ang Peste! ðŸ›",
            "Handa na ba ang Pananim mo? ðŸŒ¿",
            "Gabay sa Magsasaka! ðŸšœ"
        ];

        let index = 0;
        const flippingText = document.getElementById("flipping-text");

        setInterval(() => {
            index = (index + 1) % phrases.length;
            flippingText.style.opacity = 0; 
            setTimeout(() => {
                flippingText.innerText = phrases[index];
                flippingText.style.opacity = 1; 
            }, 500);
        }, 3000); // Change text every 3 seconds
    });
</script>


{% endblock %} {% endcomment %}
{% comment %} {% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">
        <span>Magandang Araw, <strong>{{ request.user.username }}</strong>! ðŸŒ¾</span>
        <br>
        <span id="flipping-text" class="flipping-text">Masaganang Ani sa VictoreÃ±os!</span>
    </h2>

    <div class="row justify-content-center">
        <!-- Farmers Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-seedling fa-3x mb-3"></i>
                    <h5 class="card-title fw-bold text-uppercase">Magsasaka</h5>
                    <h1 class="display-4 fw-bold">{{ farmer_count }}</h1>
                </div>
            </div>
        </div>

        <!-- Experts Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-user-tie fa-3x mb-3"></i>
                    <h5 class="card-title fw-bold text-uppercase">Eksperto</h5>
                    <h1 class="display-4 fw-bold">{{ expert_count }}</h1>
                </div>
            </div>
        </div>

        <!-- Consultations Count Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-warning shadow-lg rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <h5 class="card-title fw-bold text-uppercase">Konsultasyon</h5>
                    <h1 class="display-4 fw-bold">{{ consultation_count }}</h1>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Chart -->
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-lg rounded-4 border-0 p-3">
                <div class="card-body">
                    <h6 class="card-title text-center fw-bold">Paghahambing ng Bilang</h6>
                    <div style="width: 100%; height: 250px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Solved vs Unsolved Consultation Chart -->
<div class="col-md-6 col-lg-6 mb-4">
    <div class="card shadow-lg rounded-4 border-0 p-3">
        <div class="card-body">
            <h6 class="card-title text-center fw-bold">Solved vs Unsolved Consultations</h6>
            <div style="width: 100%; height: 250px;">
                <canvas id="consultationStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Barangay Consultation Distribution -->
<div class="col-md-6 col-lg-6 mb-4">
    <div class="card shadow-lg rounded-4 border-0 p-3">
        <div class="card-body">
            <h6 class="card-title text-center fw-bold">Consultation Records per Barangay</h6>
            <div style="width: 100%; height: 250px;">
                <canvas id="barangayConsultationChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Consultation Trends -->
<div class="col-12 mb-4">
    <div class="card shadow-lg rounded-4 border-0 p-3">
        <div class="card-body">
            <h6 class="card-title text-center fw-bold">Monthly Consultation Trends</h6>
            <div style="width: 100%; height: 250px;">
                <canvas id="monthlyConsultationChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Put these right before your <script> that contains Chart.js setup -->
    {{ barangay_data|json_script:"barangay-data" }}
    {{ consultation_trends_data|json_script:"trend-data" }}

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById("comparisonChart").getContext("2d");

            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Magsasaka", "Eksperto", "Konsultasyon"],
                    datasets: [
                        {
                            label: "Magsasaka",
                            data: [{{ farmer_count }}, 0, 0],
                            backgroundColor: "#28a745"
                        },
                        {
                            label: "Eksperto - Approved",
                            data: [0, {{ expert_approved }}, 0],
                            backgroundColor: "#007bff"
                        },
                        {
                            label: "Eksperto - Pending",
                            data: [0, {{ expert_pending }}, 0],
                            backgroundColor: "#ffc107"
                        },
                        {
                            label: "Eksperto - Rejected",
                            data: [0, {{ expert_rejected }}, 0],
                            backgroundColor: "#dc3545"
                        },
                        {
                            label: "Konsultasyon",
                            data: [0, 0, {{ consultation_count }}],
                            backgroundColor: "#fd7e14"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max({{ farmer_count }}, {{ expert_approved }}, {{ expert_pending }}, {{ expert_rejected }}, {{ consultation_count }}) + 2,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { position: "top" }
                    }
                }
            });
        });
    </script>

    <!-- Flipping Text Style -->
    <style>
        .flipping-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            display: inline-block;
            position: relative;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <!-- Flipping Text JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const phrases = [
                "Masaganang Ani sa VictoreÃ±os! ðŸŒ¾",
                "Malusog na Palay! ðŸŒ±",
                "Alamin ang Peste! ðŸ›",
                "Handa na ba ang Pananim mo? ðŸŒ¿",
                "Gabay sa Magsasaka! ðŸšœ"
            ];

            let index = 0;
            const flippingText = document.getElementById("flipping-text");

            setInterval(() => {
                index = (index + 1) % phrases.length;
                flippingText.style.opacity = 0;
                setTimeout(() => {
                    flippingText.innerText = phrases[index];
                    flippingText.style.opacity = 1;
                }, 500);
            }, 3000);
        });


        {% comment %} consultation charts {% endcomment %}
        {% comment %} document.addEventListener("DOMContentLoaded", function () {
            // 1. Solved vs Unsolved Consultation
            new Chart(document.getElementById("consultationStatusChart"), {
                type: "bar",
                data: {
                    labels: ["Solved", "Unsolved"],
                    datasets: [{
                        label: "Consultation Cases",
                        data: [{{ consultation_solved }}, {{ consultation_unsolved }}],
                        backgroundColor: ["#28a745", "#dc3545"]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
    
            // 2. Consultations per Barangay
            const barangayData = JSON.parse(document.getElementById("barangay-data").textContent);
            new Chart(document.getElementById("barangayConsultationChart"), {
                type: "pie",
                data: {
                    labels: Object.keys(barangayData),
                    datasets: [{
                        data: Object.values(barangayData),
                        backgroundColor: [
                            "#007bff", "#ffc107", "#28a745", "#dc3545", "#17a2b8",
                            "#6610f2", "#fd7e14", "#6f42c1", "#20c997", "#e83e8c"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
    
            // 3. Monthly Consultation Trends
            const trendData = JSON.parse(document.getElementById("trend-data").textContent);
            new Chart(document.getElementById("monthlyConsultationChart"), {
                type: "line",
                data: {
                    labels: Object.keys(trendData),
                    datasets: [{
                        label: "Consultations per Month",
                        data: Object.values(trendData),
                        fill: false,
                        borderColor: "#007bff",
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        });
    </script>

</div>
{% endblock %} {% endcomment %} 

{% comment %} {% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">
        <span>Magandang Araw, <strong>{{ request.user.username }}</strong>! ðŸŒ¾</span><br>
        <span id="flipping-text" class="flipping-text">Masaganang Ani sa VictoreÃ±os!</span>
    </h2>

    <div class="row justify-content-center">
        <!-- Farmers -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-seedling fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Magsasaka</h5>
                <h1 class="display-4 fw-bold">{{ farmer_count }}</h1>
            </div>
        </div>

        <!-- Experts -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-user-tie fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Eksperto</h5>
                <h1 class="display-4 fw-bold">{{ expert_count }}</h1>
            </div>
        </div>

        <!-- Consultations -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card text-white bg-warning shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Konsultasyon</h5>
                <h1 class="display-4 fw-bold">{{ consultation_count }}</h1>
            </div>
        </div>
    </div>

<!-- Calendar section with explicit styling -->
<div class="col-12 my-5">
    <div class="card shadow rounded-4 p-3">
        <h6 class="text-center fw-bold mb-3">Paganib ng Prediksyon</h6>
        <!-- Add explicit dimensions to the calendar container -->
        <div id="calendar" style="height: 600px; width: 100%;"></div>
    </div>
</div>

<!-- Ensure all required FullCalendar files are included -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- DEBUG: Add this div to check if events are available -->
<div id="debug-calendar-events" style="display: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Debug events data - Add proper error handling for template variable
            let eventsData = [];
            try {
                eventsData = {{ calendar_events_json|safe }};
                console.log("Calendar events loaded:", eventsData);
            } catch (error) {
                console.error("Failed to parse calendar events:", error);
                // Provide fallback empty array if data isn't available
                eventsData = [];
            }
            
            // Get calendar element
            const calendarEl = document.getElementById('calendar');
            
            if (!calendarEl) {
                console.error("Calendar element not found!");
                return;
            }
            
            // Create calendar with explicit options
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: eventsData,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                // Use explicit height instead of percentage
                height: 600,
                // Only use bootstrap theme if you've included the proper plugin
                // themeSystem: 'bootstrap5',
                eventDidMount: function(info) {
                    console.log("Event mounted:", info.event.title);
                }
            });
            
            // Render the calendar
            calendar.render();
            console.log("Calendar render method called");
            
        } catch (err) {
            console.error("Error in calendar initialization:", err);
            // Display error message in calendar container for easier debugging
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                calendarEl.innerHTML = '<div class="alert alert-danger">Failed to load calendar: ' + err.message + '</div>';
            }
        }
    });
</script>
    <!-- Charts Grid -->
    <div class="row g-4 justify-content-center">
        <!-- Comparison Chart -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Paghahambing ng Bilang</h6>
                <div style="height: 250px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Solved vs Unsolved -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Nalutas vs Hindi Nalutas na Konsultasyon</h6>
                <div style="height: 250px;">
                    <canvas id="consultationStatusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow rounded-4 p-3 h-100">
                    <h6 class="text-center fw-bold mb-3">Nakasolusyunan na mga Konsultasyon: Sakit laban sa Peste</h6>
                    <div class="d-flex justify-content-center align-items-center">
                        <canvas id="consultationTypeChart" style="width:100%; height:auto;"></canvas>
                    </div>
                </div>
            </div>
        
            <!-- Barangay Consultation Pie Chart -->
            <div class="col-md-6 mb-4">
                <div class="card shadow rounded-4 p-3 h-100">
                    <h6 class="text-center fw-bold mb-3">Mga Rekord ng Konsultasyon kada Barangay</h6>
                    <div class="d-flex justify-content-center align-items-center">
                        <canvas id="barangayConsultationChart" style="width:100%; height:auto;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Trends with Scroll -->
        <div class="col-12">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Mga Trend ng Buwanang Konsultasyon</h6>
                <div style="overflow-x: auto;">
                    <div style="min-width: 600px; height: 250px;">
                        <canvas id="monthlyConsultationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {{ barangay_data|json_script:"barangay-data" }}
    {{ consultation_trends_data|json_script:"trend-data" }}

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Comparison Chart
            new Chart(document.getElementById("comparisonChart"), {
                type: "bar",
                data: {
                    labels: ["Magsasaka", "Eksperto", "Konsultasyon"],
                    datasets: [
                        {
                            label: "Magsasaka",
                            data: [{{ farmer_count }}, 0, 0],
                            backgroundColor: "#28a745"
                        },
                        {
                            label: "Eksperto - Approved",
                            data: [0, {{ expert_approved }}, 0],
                            backgroundColor: "#007bff"
                        },
                        {
                            label: "Eksperto - Pending",
                            data: [0, {{ expert_pending }}, 0],
                            backgroundColor: "#ffc107"
                        },
                        {
                            label: "Eksperto - Rejected",
                            data: [0, {{ expert_rejected }}, 0],
                            backgroundColor: "#dc3545"
                        },
                        {
                            label: "Konsultasyon",
                            data: [0, 0, {{ consultation_count }}],
                            backgroundColor: "#fd7e14"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: { legend: { position: "top" } }
                }
            });

            // Solved vs Unsolved
            new Chart(document.getElementById("consultationStatusChart"), {
                type: "bar",
                data: {
                    labels: ["Solved", "Unsolved"],
                    datasets: [{
                        label: "Consultation Cases",
                        data: [{{ consultation_solved }}, {{ consultation_unsolved }}],
                        backgroundColor: ["#28a745", "#dc3545"]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Barangay Distribution
            const barangayData = JSON.parse(document.getElementById("barangay-data").textContent);
            new Chart(document.getElementById("barangayConsultationChart"), {
                type: "pie",
                data: {
                    labels: Object.keys(barangayData),
                    datasets: [{
                        data: Object.values(barangayData),
                        backgroundColor: [
                            "#007bff", "#ffc107", "#28a745", "#dc3545", "#17a2b8",
                            "#6610f2", "#fd7e14", "#6f42c1", "#20c997", "#e83e8c"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Monthly Trend Chart
            const trendData = JSON.parse(document.getElementById("trend-data").textContent);
            new Chart(document.getElementById("monthlyConsultationChart"), {
                type: "line",
                data: {
                    labels: Object.keys(trendData),
                    datasets: [{
                        label: "Consultations per Month",
                        data: Object.values(trendData),
                        fill: false,
                        borderColor: "#007bff",
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        });
    </script>

    <!-- Flipping Text Animation -->
    <style>
        .flipping-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            display: inline-block;
            position: relative;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const phrases = [
                "Masaganang Ani sa VictoreÃ±os! ðŸŒ¾",
                "Malusog na Palay! ðŸŒ±",
                "Alamin ang Peste! ðŸ›",
                "Handa na ba ang Pananim mo? ðŸŒ¿",
                "Gabay sa Magsasaka! ðŸšœ"
            ];
            let index = 0;
            const flippingText = document.getElementById("flipping-text");

            setInterval(() => {
                index = (index + 1) % phrases.length;
                flippingText.style.opacity = 0;
                setTimeout(() => {
                    flippingText.innerText = phrases[index];
                    flippingText.style.opacity = 1;
                }, 500);
            }, 3000);
        });
    </script>

    {% comment %} SCRIPT SA CHART NG SAKIT VS PESTE {% endcomment %}
    {% comment %} <script>
        const consultationTypeCtx = document.getElementById("consultationTypeChart").getContext("2d");
    
        const consultationTypeChart = new Chart(consultationTypeCtx, {
            type: "pie",
            data: {
                labels: ["Sakit", "Peste"],
                datasets: [{
                    data: [
                        {{ consultation_type_chart_data.solved_sakit|default:0 }},
                        {{ consultation_type_chart_data.solved_peste|default:0 }}
                    ],
                    backgroundColor: [
                        "#f94144",  // red for Sakit
                        "#43aa8b"   // green for Peste
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Solved Consultations by Classification'
                    }
                }
            }
        });
    </script>
</div>
{% endblock %}


 {% endcomment %}
