{% extends 'expert/base_expert.html' %}
{% block content %}

<!-- Added comprehensive CSS styling for enhanced dashboard appearance -->
<style>
    .dashboard-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(25, 135, 84, 0.3);
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: none;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        color: #2c3e50;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0;
    }
    
    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: none;
        margin-bottom: 2rem;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .chart-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    /* Fixed weather card layout and alignment */
    .weather-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 20px;
        color: white;
        box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        overflow: hidden;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .weather-header {
        padding: 1.2rem;
        text-align: center;
        position: relative;
        flex-shrink: 0;
    }
    
    .weather-icon {
        font-size: 2.5rem;
        margin: 0.8rem 0;
        opacity: 0.9;
    }
    
    .temperature {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0.3rem 0;
    }
    
    .weather-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        padding: 0.8rem 1.2rem;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
    }
    
    .weather-item {
        text-align: center;
        padding: 0.3rem;
    }
    
    .weather-item i {
        font-size: 1rem;
        margin-bottom: 0.3rem;
        opacity: 0.8;
    }
    
    .forecast-section {
        padding: 0.8rem 1.2rem;
        background: rgba(255,255,255,0.05);
        flex: 1;
        overflow-y: auto;
    }
    
    .forecast-item {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 0.6rem;
        margin-bottom: 0.4rem;
        backdrop-filter: blur(5px);
    }
    
    .forecast-day {
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .forecast-temp {
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .farming-alert {
        margin: 0.8rem 1.2rem;
        padding: 0.8rem;
        border-radius: 8px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-left: 4px solid #ffc107;
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    .farming-alert.rain {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }
    
    .farming-alert.heat {
        border-left-color: #fd7e14;
        background: rgba(253, 126, 20, 0.1);
    }
    
    .last-updated {
        text-align: center;
        padding: 0.6rem;
        font-size: 0.75rem;
        opacity: 0.8;
        background: rgba(255,255,255,0.05);
        flex-shrink: 0;
    }

    /* Added consistent row heights and alignment */
    .equal-height-row {
        display: flex;
        align-items: stretch;
    }
    
    .equal-height-row > [class*="col-"] {
        display: flex;
        flex-direction: column;
    }
    
    .equal-height-row .chart-card,
    .equal-height-row .weather-card {
        flex: 1;
        margin-bottom: 0;
    }

    /* Improved responsive design */
    @media (max-width: 768px) {
        .weather-details {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .dashboard-header {
            padding: 1.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
        }
        
        .temperature {
            font-size: 2rem;
        }
        
        .chart-card {
            margin-bottom: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .dashboard-container {
            padding: 1rem 0;
        }
        
        .weather-details {
            grid-template-columns: 1fr;
            gap: 0.3rem;
        }
        
        .forecast-item {
            padding: 0.5rem;
        }
    }
    
    .weather-card.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .weather-card.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px;
        height: 30px;
        margin: -15px 0 0 -15px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        color: #ffc107;
        font-weight: 500;
    }
</style>

<div class="dashboard-container">
    <div class="container">
        <!-- Enhanced dashboard header with expert greeting -->
        <div class="dashboard-header text-center">
            <h1 class="mb-2">
                <i class="fas fa-leaf me-3"></i>
                AgriExpert Dashboard
            </h1>
            <p class="mb-0 fs-5">Maligayang pagdating sa inyong expert consultation platform</p>
            <small class="opacity-75">Monitoring agricultural consultations and weather conditions</small>
        </div>

        <!-- Enhanced statistics cards with icons and better styling -->
        <div class="row mb-4 equal-height-row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <h2 class="stat-number">{{ unique_farmers }}</h2>
                    <p class="stat-label">Mga Magsasakang Nakipag-ugnay</p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="stat-number">{{ solved_consultations }}</h2>
                    <p class="stat-label">Nalutas na Konsultasyon</p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h2 class="stat-number">{{ unsolved_consultations }}</h2>
                    <p class="stat-label">Hindi pa Nalulutas</p>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card">
                    <div class="stat-icon bg-info bg-opacity-10 text-info">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h2 class="stat-number">{{ total_consultations }}</h2>
                    <p class="stat-label">Kabuuang Konsultasyon</p>
                </div>
            </div>
        </div>

        <!-- Redesigned weather and activity section with proper alignment -->
        <div class="row mb-4 equal-height-row">
            <!-- Compact Weather Widget -->
            <div class="col-lg-4 mb-4">
                <div class="weather-card p-0" id="weatherCard">
                    <div class="weather-header">
                        <h6 class="mb-1"><i class="fas fa-map-marker-alt me-1"></i>Victoria, Oriental Mindoro</h6>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="temperature" id="currentTemp">--°C</div>
                                <small id="weatherCondition">Loading weather...</small>
                            </div>
                            <div class="weather-icon" id="weatherIcon">
                                <i class="fas fa-cloud"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="weather-item">
                            <i class="fas fa-tint"></i>
                            <small>Humidity<br><span id="humidity">--%</span></small>
                        </div>
                        <div class="weather-item">
                            <i class="fas fa-wind"></i>
                            <small>Wind<br><span id="windSpeed">-- km/h</span></small>
                        </div>
                        <div class="weather-item">
                            <i class="fas fa-thermometer-half"></i>
                            <small>Feels Like<br><span id="feelsLike">--°C</span></small>
                        </div>
                    </div>

                    <!-- Compact 5-Day Forecast -->
                    <div class="forecast-section">
                        <h6 class="text-center mb-2" style="font-size: 0.9rem;">5-Day Forecast</h6>
                        <div id="forecastContainer">
                            <div class="forecast-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="forecast-day">Ngayon</span>
                                    <i class="fas fa-cloud-sun" style="font-size: 1rem;"></i>
                                    <span class="forecast-temp">30°/24°</span>
                                </div>
                                <div class="text-center mt-1">
                                    <small>Maambon</small>
                                </div>
                            </div>
                            <div class="forecast-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="forecast-day">Bukas</span>
                                    <i class="fas fa-cloud-rain" style="font-size: 1rem;"></i>
                                    <span class="forecast-temp">28°/23°</span>
                                </div>
                                <div class="text-center mt-1">
                                    <small>Umuulan</small>
                                </div>
                            </div>
                            <div class="forecast-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="forecast-day">Sabado</span>
                                    <i class="fas fa-sun" style="font-size: 1rem;"></i>
                                    <span class="forecast-temp">32°/25°</span>
                                </div>
                                <div class="text-center mt-1">
                                    <small>Malinaw</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Added farming alert inside forecast section for better space usage -->
                        <div id="farmingAlert" class="farming-alert" style="display: none;"></div>
                        <div class="text-center mt-2">
                            <small class="text-muted">No critical alerts at the moment.</small>
                        </div>
                    </div>

                    <div class="last-updated" id="lastUpdated">
                        Last updated: Real-time
                    </div>
                </div>
            </div>

            <!-- Enhanced Recent Activity with improved layout and styling -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card h-100">
                    <h5 class="chart-title">
                        <i class="fas fa-clock me-2 text-info"></i>
                        Recent Activity
                    </h5>
                    
                    <!-- Fixed layout structure and improved styling for 2x3 grid -->
                    <div class="row g-3 mb-4">
                        <!-- First Row -->
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.new_consultations_today }}</h4>
                                <small class="text-muted fw-medium">New Today</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.pending_responses }}</h4>
                                <small class="text-muted fw-medium">Pending</small>
                            </div>
                        </div>
                        
                        <!-- Second Row -->
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-book"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.library_items_total }}</h4>
                                <small class="text-muted fw-medium">Library Items</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-primary bg-opacity-10 text-primary mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.active_conversations }}</h4>
                                <small class="text-muted fw-medium">Active Chats</small>
                            </div>
                        </div>
                        
                        <!-- Third Row - Fixed escaped HTML and improved styling -->
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-secondary bg-opacity-10 text-secondary mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.messages_sent_today }}</h4>
                                <small class="text-muted fw-medium">Sent Today</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="activity-stat-card text-center p-3 bg-light rounded-3 h-100">
                                <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="fas fa-check-double"></i>
                                </div>
                                <h4 class="mb-1 fw-bold text-dark">{{ recent_activity.solutions_this_week }}</h4>
                                <small class="text-muted fw-medium">Solutions</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Improved Quick Actions styling -->
                    <div class="mt-auto">
                        <h6 class="mb-3 text-muted fw-semibold">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm py-2" onclick="window.location.href='/expert/library/'">
                                <i class="fas fa-book me-2"></i>View Library
                            </button>
                            <button class="btn btn-outline-success btn-sm py-2" onclick="window.location.href='/expert/report/'">
                                <i class="fas fa-chart-line me-2"></i>View Reports
                            </button>
                            <button class="btn btn-outline-info btn-sm py-2" onclick="window.location.href='/expert/experts/'">
                                <i class="fas fa-users me-2"></i>View Experts
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Enhanced consultation overview chart -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Consultation Overview
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="expertChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts section with consistent equal heights -->
        <div class="row equal-height-row">
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie me-2 text-success"></i>
                        Solved vs Unsolved
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="solvedChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-map-marked-alt me-2 text-info"></i>
                        Consultations per Barangay
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="barangayChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced monthly trends chart -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-line me-2 text-warning"></i>
                        Monthly Consultation Trends
                    </h5>
                    <div style="height: 350px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-card">
                    <h4 class="chart-title text-center mb-4">
                        <i class="fas fa-chart-area me-2 text-success"></i>
                        Advanced Agricultural Analytics
                    </h4>
                </div>
            </div>
        </div>

        <!-- Disease/Pest Classification & AI Prediction Analytics -->
        <div class="row mb-4 equal-height-row">
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-bug me-2 text-danger"></i>
                        Disease vs Pest Classification
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="classificationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-brain me-2 text-purple"></i>
                        AI Prediction Confidence Levels
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="confidenceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expert Engagement & Community Activity -->
        <div class="row mb-4 equal-height-row">
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-thumbs-up me-2 text-primary"></i>
                        Expert Post Engagement
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-clock me-2 text-warning"></i>
                        Problem Resolution Timeline
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="resolutionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Most Common Diseases & Seasonal Patterns -->
        <div class="row mb-4 equal-height-row">
            <div class="col-lg-8 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-seedling me-2 text-success"></i>
                        Most Common Agricultural Issues
                    </h5>
                    <div style="height: 350px; flex: 1;">
                        <canvas id="commonIssuesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-calendar-alt me-2 text-info"></i>
                        Seasonal Activity Pattern
                    </h5>
                    <div style="height: 350px; flex: 1;">
                        <canvas id="seasonalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Usage & Expert Performance -->
        <div class="row mb-4 equal-height-row">
            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-book me-2 text-secondary"></i>
                        Knowledge Base Access Trends
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="knowledgeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="chart-card">
                    <h5 class="chart-title">
                        <i class="fas fa-medal me-2 text-warning"></i>
                        Expert Performance Metrics
                    </h5>
                    <div style="height: 300px; flex: 1;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Enhanced Chart.js configurations with better styling -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Enhanced Expert Stats Chart
        var ctx = document.getElementById("expertChart").getContext("2d");
        new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Farmers Contacted", "Solved Consultations", "Unsolved Consultations"],
                datasets: [{
                    label: "Expert Statistics",
                    data: [{{ unique_farmers }}, {{ solved_consultations }}, {{ unsolved_consultations }}],
                    backgroundColor: [
                        "rgba(25, 135, 84, 0.8)",
                        "rgba(32, 201, 151, 0.8)", 
                        "rgba(255, 193, 7, 0.8)"
                    ],
                    borderColor: [
                        "rgba(25, 135, 84, 1)",
                        "rgba(32, 201, 151, 1)",
                        "rgba(255, 193, 7, 1)"
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false 
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: { 
                            stepSize: 1,
                            color: '#6c757d'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    }
                }
            }
        });

        // Enhanced Solved vs Unsolved Doughnut Chart
        const solvedChart = new Chart(document.getElementById("solvedChart"), {
            type: "doughnut",
            data: {
                labels: ["Solved", "Unsolved"],
                datasets: [{
                    label: "Consultations",
                    data: [{{ solved_consultations }}, {{ unsolved_consultations }}],
                    backgroundColor: [
                        "rgba(32, 201, 151, 0.8)",
                        "rgba(255, 193, 7, 0.8)"
                    ],
                    borderColor: [
                        "rgba(32, 201, 151, 1)",
                        "rgba(255, 193, 7, 1)"
                    ],
                    borderWidth: 3,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            color: '#6c757d'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                },
                cutout: '60%'
            }
        });

        // Enhanced Barangay Pie Chart
        const barangayChart = new Chart(document.getElementById("barangayChart"), {
            type: "pie",
            data: {
                labels: {{ barangay_labels|safe }},
                datasets: [{
                    label: "Consultations",
                    data: {{ barangay_counts|safe }},
                    backgroundColor: [
                        "rgba(25, 135, 84, 0.8)",
                        "rgba(32, 201, 151, 0.8)",
                        "rgba(13, 202, 240, 0.8)",
                        "rgba(255, 193, 7, 0.8)",
                        "rgba(220, 53, 69, 0.8)",
                        "rgba(108, 117, 125, 0.8)",
                        "rgba(253, 126, 20, 0.8)",
                        "rgba(111, 66, 193, 0.8)"
                    ],
                    borderColor: [
                        "rgba(25, 135, 84, 1)",
                        "rgba(32, 201, 151, 1)",
                        "rgba(13, 202, 240, 1)",
                        "rgba(255, 193, 7, 1)",
                        "rgba(220, 53, 69, 1)",
                        "rgba(108, 117, 125, 1)",
                        "rgba(253, 126, 20, 1)",
                        "rgba(111, 66, 193, 1)"
                    ],
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            color: '#6c757d'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                }
            }
        });

        // Enhanced Monthly Trend Line Chart
        const monthlyChart = new Chart(document.getElementById("monthlyChart"), {
            type: "line",
            data: {
                labels: {{ month_labels|safe }},
                datasets: [{
                    label: "Unique Farmers Consulted",
                    data: {{ month_counts|safe }},
                    fill: true,
                    backgroundColor: "rgba(25, 135, 84, 0.1)",
                    borderColor: "rgba(25, 135, 84, 1)",
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: "rgba(25, 135, 84, 1)",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#6c757d'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        stepSize: 1,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    }
                }
            }
        });

        // NEW ADVANCED CHARTS WITH REAL DATA

        const classificationChart = new Chart(document.getElementById("classificationChart"), {
            type: "doughnut",
            data: {
                labels: {{ classification_labels|safe }},
                datasets: [{
                    label: "Classification",
                    data: {{ classification_data|safe }},
                    backgroundColor: [
                        "rgba(220, 53, 69, 0.8)",
                        "rgba(255, 193, 7, 0.8)",
                        "rgba(108, 117, 125, 0.8)"
                    ],
                    borderColor: [
                        "rgba(220, 53, 69, 1)",
                        "rgba(255, 193, 7, 1)",
                        "rgba(108, 117, 125, 1)"
                    ],
                    borderWidth: 2,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            color: '#6c757d'
                        }
                    }
                },
                cutout: '50%'
            }
        });

        const confidenceChart = new Chart(document.getElementById("confidenceChart"), {
            type: "bar",
            data: {
                labels: {{ confidence_labels|safe }},
                datasets: [{
                    label: "Predictions",
                    data: {{ confidence_data|safe }},
                    backgroundColor: [
                        "rgba(25, 135, 84, 0.8)",
                        "rgba(32, 201, 151, 0.8)",
                        "rgba(255, 193, 7, 0.8)",
                        "rgba(253, 126, 20, 0.8)",
                        "rgba(220, 53, 69, 0.8)"
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const engagementChart = new Chart(document.getElementById("engagementChart"), {
            type: "line",
            data: {
                labels: {{ engagement_months|safe }},
                datasets: [{
                    label: "Posts Created",
                    data: {{ posts_data|safe }},
                    borderColor: "rgba(13, 202, 240, 1)",
                    backgroundColor: "rgba(13, 202, 240, 0.1)",
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: "rgba(13, 202, 240, 1)",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#6c757d'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        stepSize: 1,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    }
                }
            }
        });


        const resolutionChart = new Chart(document.getElementById("resolutionChart"), {
            type: "bar",
            data: {
                labels: {{ resolution_labels|safe }},
                datasets: [{
                    label: "Consultations Resolved",
                    data: {{ resolution_data|safe }},
                    backgroundColor: [
                        "rgba(25, 135, 84, 0.8)",
                        "rgba(32, 201, 151, 0.8)",
                        "rgba(255, 193, 7, 0.8)",
                        "rgba(253, 126, 20, 0.8)",
                        "rgba(220, 53, 69, 0.8)"
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const commonIssuesChart = new Chart(document.getElementById("commonIssuesChart"), {
            type: "bar",
            data: {
                labels: {{ issue_labels|safe }},
                datasets: [{
                    label: "Occurrences",
                    data: {{ issue_counts|safe }},
                    backgroundColor: [
                        "rgba(220, 53, 69, 0.8)",
                        "rgba(255, 193, 7, 0.8)",
                        "rgba(253, 126, 20, 0.8)",
                        "rgba(25, 135, 84, 0.8)",
                        "rgba(13, 202, 240, 0.8)",
                        "rgba(111, 66, 193, 0.8)",
                        "rgba(108, 117, 125, 0.8)"
                    ],
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        const seasonalChart = new Chart(document.getElementById("seasonalChart"), {
            type: "polarArea",
            data: {
                labels: {{ seasonal_labels|safe }},
                datasets: [{
                    label: "Activity Level",
                    data: {{ seasonal_data|safe }},
                    backgroundColor: [
                        "rgba(253, 126, 20, 0.6)",
                        "rgba(13, 202, 240, 0.6)",
                        "rgba(25, 135, 84, 0.6)",
                        "rgba(255, 193, 7, 0.6)"
                    ],
                    borderColor: [
                        "rgba(253, 126, 20, 1)",
                        "rgba(13, 202, 240, 1)",
                        "rgba(25, 135, 84, 1)",
                        "rgba(255, 193, 7, 1)"
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        const knowledgeChart = new Chart(document.getElementById("knowledgeChart"), {
            type: "line",
            data: {
                labels: {{ knowledge_months|safe }},
                datasets: [{
                    label: "Library Items Added",
                    data: {{ knowledge_data|safe }},
                    fill: true,
                    backgroundColor: "rgba(108, 117, 125, 0.1)",
                    borderColor: "rgba(108, 117, 125, 1)",
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: "rgba(108, 117, 125, 1)",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#6c757d'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        stepSize: 1,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#6c757d'
                        }
                    }
                }
            }
        });

        const performanceChart = new Chart(document.getElementById("performanceChart"), {
            type: "radar",
            data: {
                labels: ["Posts Created", "Upvotes Received", "Comments Made", "Consultations", "Solutions Provided"],
                datasets: [{
                    label: "Your Performance",
                    data: [
                        {{ performance_metrics.total_posts }},
                        {{ performance_metrics.upvotes_received }},
                        {{ performance_metrics.comments_made }},
                        {{ performance_metrics.consultations_handled }},
                        {{ performance_metrics.solutions_provided }}
                    ],
                    backgroundColor: "rgba(25, 135, 84, 0.2)",
                    borderColor: "rgba(25, 135, 84, 1)",
                    borderWidth: 2,
                    pointBackgroundColor: "rgba(25, 135, 84, 1)",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: Math.max(10, {{ performance_metrics.total_posts }}, {{ performance_metrics.upvotes_received }}, {{ performance_metrics.comments_made }}, {{ performance_metrics.consultations_handled }}, {{ performance_metrics.solutions_provided }}) + 5
                    }
                }
            }
        });
    });
</script>

<!-- Added comprehensive weather service JavaScript -->
<script>
class WeatherService {
    constructor() {
        // Using OpenWeatherMap API - Free tier allows 1000 calls/day
        this.apiKey = '38e8d673902b4e0024dabf392ced78b4'; // Replace with your actual API key
        this.city = 'Victoria,PH';
        this.lat = 13.1858; // Victoria, Oriental Mindoro coordinates
        this.lon = 121.3299;
        this.updateInterval = 10 * 60 * 1000; // Update every 10 minutes
        this.init();
    }

    init() {
        this.updateWeather();
        setInterval(() => this.updateWeather(), this.updateInterval);
    }

    async updateWeather() {
        try {
            document.getElementById('weatherCard').classList.add('loading');
            
            // Get current weather
            const currentWeather = await this.getCurrentWeather();
            // Get 5-day forecast
            const forecast = await this.getForecast();
            
            this.displayCurrentWeather(currentWeather);
            this.displayForecast(forecast);
            this.displayFarmingAlert(currentWeather);
            this.updateLastUpdated();
            
            document.getElementById('weatherCard').classList.remove('loading');
        } catch (error) {
            this.displayError();
            console.error('Weather update failed:', error);
        }
    }

    async getCurrentWeather() {
        const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric&lang=en`
        );
        
        if (!response.ok) {
            throw new Error('Weather API request failed');
        }
        
        return await response.json();
    }

    async getForecast() {
        const response = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric&lang=en`
        );
        
        if (!response.ok) {
            throw new Error('Forecast API request failed');
        }
        
        return await response.json();
    }

    displayCurrentWeather(data) {
        // Update current weather
        document.getElementById('currentTemp').textContent = `${Math.round(data.main.temp)}°C`;
        document.getElementById('weatherCondition').textContent = this.translateCondition(data.weather[0].description);
        document.getElementById('humidity').textContent = `${data.main.humidity}%`;
        document.getElementById('windSpeed').textContent = `${Math.round(data.wind.speed * 3.6)} km/h`;
        document.getElementById('feelsLike').textContent = `${Math.round(data.main.feels_like)}°C`;

        // Update weather icon
        this.updateWeatherIcon(data.weather[0].main, data.weather[0].icon);
    }

    displayForecast(data) {
        const forecastContainer = document.getElementById('forecastContainer');
        forecastContainer.innerHTML = '';

        // Group forecast data by day (take one per day, preferably noon)
        const dailyForecasts = this.processForecastData(data.list);

        dailyForecasts.forEach((forecast, index) => {
            const forecastItem = document.createElement('div');
            forecastItem.className = 'forecast-item';
            
            const day = index === 0 ? 'Ngayon' : this.getDayName(forecast.dt);
            const icon = this.getWeatherIcon(forecast.weather[0].main);
            
            forecastItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="forecast-day">${day}</span>
                    <i class="${icon}" style="font-size: 1.2rem;"></i>
                    <span class="forecast-temp">${Math.round(forecast.main.temp_max)}°/${Math.round(forecast.main.temp_min)}°</span>
                </div>
                <div class="text-center mt-1">
                    <small>${this.translateCondition(forecast.weather[0].description)}</small>
                </div>
            `;
            
            forecastContainer.appendChild(forecastItem);
        });
    }

    displayFarmingAlert(data) {
        const alertContainer = document.getElementById('farmingAlert');
        let alertMessage = '';
        let alertClass = 'farming-alert';

        // Check for farming-relevant weather conditions
        if (data.main.humidity > 80 && data.weather[0].main.toLowerCase().includes('rain')) {
            alertMessage = '🚨 Mataas ang humidity at umuulan - Mag-ingat sa fungal diseases!';
            alertClass += ' rain';
        } else if (data.main.temp > 32) {
            alertMessage = '☀️ Mainit ngayon - Siguraduhing may sapat na tubig ang mga pananim!';
            alertClass += ' heat';
        } else if (data.wind.speed > 8) {
            alertMessage = '💨 Malakas ang hangin - Protektahan ang mga young plants!';
        } else if (data.main.humidity < 40) {
            alertMessage = '🌾 Dry conditions - Maganda para sa harvesting!';
        }

        if (alertMessage) {
            alertContainer.innerHTML = alertMessage;
            alertContainer.className = alertClass;
            alertContainer.style.display = 'block';
        } else {
            alertContainer.style.display = 'none';
        }
    }

    processForecastData(forecastList) {
        const dailyData = {};
        
        forecastList.forEach(item => {
            const date = new Date(item.dt * 1000).toDateString();
            
            if (!dailyData[date]) {
                dailyData[date] = {
                    ...item,
                    main: {
                        ...item.main,
                        temp_min: item.main.temp_min,
                        temp_max: item.main.temp_max
                    }
                };
            } else {
                // Update min/max temperatures for the day
                dailyData[date].main.temp_min = Math.min(dailyData[date].main.temp_min, item.main.temp_min);
                dailyData[date].main.temp_max = Math.max(dailyData[date].main.temp_max, item.main.temp_max);
                
                // Prefer noon data for main weather condition
                const itemHour = new Date(item.dt * 1000).getHours();
                const currentHour = new Date(dailyData[date].dt * 1000).getHours();
                if (Math.abs(itemHour - 12) < Math.abs(currentHour - 12)) {
                    dailyData[date].weather = item.weather;
                    dailyData[date].main.temp = item.main.temp;
                }
            }
        });

        return Object.values(dailyData).slice(0, 5);
    }

    updateWeatherIcon(condition, iconCode = '') {
        const iconElement = document.querySelector('#weatherIcon i');
        iconElement.className = this.getWeatherIcon(condition, iconCode);
    }

    getWeatherIcon(condition, iconCode = '') {
        const conditionLower = condition.toLowerCase();
        
        if (conditionLower.includes('rain') || conditionLower.includes('drizzle')) {
            return 'fas fa-cloud-rain';
        } else if (conditionLower.includes('thunderstorm')) {
            return 'fas fa-bolt';
        } else if (conditionLower.includes('snow')) {
            return 'fas fa-snowflake';
        } else if (conditionLower.includes('mist') || conditionLower.includes('fog')) {
            return 'fas fa-smog';
        } else if (conditionLower.includes('cloud')) {
            return iconCode && iconCode.includes('n') ? 'fas fa-cloud-moon' : 'fas fa-cloud';
        } else if (conditionLower.includes('clear')) {
            return iconCode && iconCode.includes('n') ? 'fas fa-moon' : 'fas fa-sun';
        } else {
            return 'fas fa-cloud-sun';
        }
    }

    translateCondition(condition) {
        const translations = {
            'clear sky': 'Malinaw na langit',
            'few clouds': 'Kaunting ulap',
            'scattered clouds': 'Kalat-kalat na ulap',
            'broken clouds': 'Maulap',
            'overcast clouds': 'Napakaulap',
            'light rain': 'Maambon',
            'moderate rain': 'Umuulan',
            'heavy rain': 'Malakas na ulan',
            'very heavy rain': 'Napakalakas na ulan',
            'extreme rain': 'Sobrang lakas ng ulan',
            'thunderstorm': 'May kidlat at kulog',
            'thunderstorm with light rain': 'Kidlat at ambon',
            'thunderstorm with rain': 'Kidlat at ulan',
            'thunderstorm with heavy rain': 'Malakas na bagyo',
            'mist': 'Mahamog',
            'fog': 'Malaking hamog',
            'haze': 'Maalikabok'
        };

        return translations[condition.toLowerCase()] || condition;
    }

    getDayName(timestamp) {
        const days = ['Linggo', 'Lunes', 'Martes', 'Miyerkules', 'Huwebes', 'Biyernes', 'Sabado'];
        const date = new Date(timestamp * 1000);
        return days[date.getDay()];
    }

    updateLastUpdated() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-PH', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
    }

    displayError() {
        document.getElementById('weatherCard').classList.remove('loading');
        document.getElementById('weatherCondition').innerHTML = 
            '<span class="error-message">Hindi ma-access ang weather data. Subukan ulit mamaya.</span>';
    }
}

// Initialize weather service when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize weather service
    const weatherService = new WeatherService();
    
    // Fallback to default weather data after 5 seconds if API fails
    setTimeout(() => {
        if (document.getElementById('currentTemp').textContent === '--°C') {
            console.log('Using default weather data...');
            // Display typical weather for Victoria, Oriental Mindoro
            document.getElementById('currentTemp').textContent = '27°C';
            document.getElementById('weatherCondition').textContent = 'Tropical na panahon';
            document.getElementById('humidity').textContent = '85%';
            document.getElementById('windSpeed').textContent = '12 km/h';
            document.getElementById('feelsLike').textContent = '30°C';
            document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit', hour12: true });
        }
    }, 5000);
});
</script>

{% endblock %}
