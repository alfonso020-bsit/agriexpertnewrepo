{% extends 'farmer/base_farmer.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Compact Weather -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow rounded-4 border-0 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">
                                Magandang Araw, <strong>{{ farmer.first_name }}!</strong> ðŸŒ¾
                            </h2>
                            <p class="mb-0" id="flipping-text">Malusog na pananim, masaganang ani!</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <!-- Compact Weather Button -->
                            <div class="d-flex justify-content-end align-items-center">
                                <div class="weather-compact me-3" id="weatherCompact">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-cloud-sun me-2" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <div class="fw-bold" id="compactTemp">--Â°C</div>
                                            <small id="compactCondition">Loading...</small>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-light btn-sm" id="weatherModalBtn" data-bs-toggle="tooltip" title="Tingnan ang buong weather forecast">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest of your dashboard content remains the same -->
    <!-- Quick Stats Cards -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-seedling fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Mga Scan</h5>
                <h1 class="display-4 fw-bold">{{ total_predictions }}</h1>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-user-tie fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Konsultasyon</h5>
                <h1 class="display-4 fw-bold">{{ consultation_count }}</h1>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Nalutas</h5>
                <h1 class="display-4 fw-bold">{{ solved_consultations }}</h1>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info shadow-lg rounded-4 border-0 text-center py-4">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <h5 class="text-uppercase fw-bold">Aktibidad</h5>
                <h1 class="display-4 fw-bold">{{ total_predictions }}</h1>
            </div>
        </div>
    </div>

    <!-- Prediction Analytics Cards -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-bug text-success fa-2x mb-2"></i>
                    <h6 class="fw-bold">Pest Detections</h6>
                    <h2 class="text-success">{{ pest_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-virus text-danger fa-2x mb-2"></i>
                    <h6 class="fw-bold">Disease Detections</h6>
                    <h2 class="text-danger">{{ disease_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow rounded-4 border-0 p-3">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line text-primary fa-2x mb-2"></i>
                    <h6 class="fw-bold">Total Detections</h6>
                    <h2 class="text-primary">{{ pest_count|add:disease_count }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Calendar Section -->
    <div class="col-12 my-5">
        <div class="card shadow rounded-4 p-3">
            <h6 class="text-center fw-bold mb-3">Kalendaryo ng Prediksyon</h6>
            <div id="calendar" style="height: 600px; width: 100%;"></div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="row g-4 justify-content-center">
        <!-- Detection Trends -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Mga Trend ng Prediksyon</h6>
                <div style="height: 250px;">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detection Summary -->
        <div class="col-md-6">
            <div class="card shadow rounded-4 p-3">
                <h6 class="text-center fw-bold mb-3">Buod ng mga Deteksyon</h6>
                <div style="height: 250px;">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Predictions Table -->
        <div class="col-12">
            <div class="card shadow rounded-4 p-3">
                <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Kamakailang mga Prediksyon
                    </h5>
                    <span class="badge bg-primary">{{ recent_predictions|length }} results</span>
                </div>
                <div class="card-body">
                    {% if recent_predictions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Petsa</th>
                                    <th>Klase</th>
                                    <th>Kumpiyansa</th>
                                    <th>Uri</th>
                                    <th>Lokasyon</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prediction in recent_predictions %}
                                <tr>
                                    <td>{{ prediction.uploaded_at|date:"M d, Y" }}</td>
                                    <td>
                                        <strong>{{ prediction.predicted_class }}</strong>
                                        {% if prediction.image_url %}
                                        <br><small class="text-muted">May Larawan</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar 
                                                {% if prediction.confidence >= 80 %}bg-success
                                                {% elif prediction.confidence >= 50 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ prediction.confidence }}%">
                                            </div>
                                        </div>
                                        <small>{{ prediction.confidence|floatformat:1 }}%</small>
                                    </td>
                                    <td>
                                        {% if prediction.predicted_class in pest_classes %}
                                        <span class="badge bg-success">Peste</span>
                                        {% else %}
                                        <span class="badge bg-danger">Sakit</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if prediction.latitude and prediction.longitude %}
                                        <i class="fas fa-map-marker-alt text-success"></i>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Walang mga prediksyon na naitala.</p>
                        <button class="btn btn-primary" onclick="showUploadModal()">
                            <i class="fas fa-upload me-2"></i>Mag-upload ng Larawan
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weather Modal -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="weatherModalLabel">
                    <i class="fas fa-cloud-sun-rain me-2"></i>
                    Panahon sa {{ farmer.barangay }}, Oriental Mindoro
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Weather Forecast Card -->
                <div class="weather-card p-0" id="weatherCard" style="background: linear-gradient(135deg, rgba(46, 125, 50, 0.95), rgba(76, 175, 80, 0.95)); border-radius: 0; box-shadow: none; color: white;">
                    <div class="weather-header" style="text-align: center; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h5 class="mb-2"><i class="fas fa-map-marker-alt me-2"></i>{{ farmer.barangay }}, Oriental Mindoro</h5>
                        <div class="weather-icon" id="weatherIcon" style="font-size: 4rem; margin-bottom: 15px;">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="temperature" id="currentTemp" style="font-size: 3rem; font-weight: bold; margin: 0;">--Â°C</div>
                        <p class="mb-0 fs-5" id="weatherCondition">Naglo-load ng data...</p>
                    </div>
                    
                    <div class="weather-details" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-eye fa-lg mb-2"></i>
                            <div>Visibility</div>
                            <div class="fw-bold fs-5" id="visibility">--</div>
                        </div>
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-tint fa-lg mb-2"></i>
                            <div>Humidity</div>
                            <div class="fw-bold fs-5" id="humidity">--%</div>
                        </div>
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-wind fa-lg mb-2"></i>
                            <div>Wind</div>
                            <div class="fw-bold fs-5" id="windSpeed">-- km/h</div>
                        </div>
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-thermometer-half fa-lg mb-2"></i>
                            <div>Feels Like</div>
                            <div class="fw-bold fs-5" id="feelsLike">--Â°C</div>
                        </div>
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-compress-arrows-alt fa-lg mb-2"></i>
                            <div>Pressure</div>
                            <div class="fw-bold fs-5" id="pressure">-- hPa</div>
                        </div>
                        <div class="weather-item" style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <i class="fas fa-sun fa-lg mb-2"></i>
                            <div>UV Index</div>
                            <div class="fw-bold fs-5" id="uvIndex">--</div>
                        </div>
                    </div>

                    <!-- Farming Alert -->
                    <div id="farmingAlert" style="display: none; padding: 15px; margin: 15px; border-radius: 10px; font-weight: bold;"></div>

                    <!-- 5-Day Forecast -->
                    <div class="forecast-section" style="padding: 20px;">
                        <h5 class="text-center mb-4"><i class="fas fa-calendar-alt me-2"></i>5-Day Weather Forecast</h5>
                        <div id="forecastContainer">
                            <!-- Forecast items will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="last-updated d-flex justify-content-between align-items-center p-3" style="font-size: 0.8rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2);">
                        <span id="lastUpdated">Last updated: --</span>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshWeather()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Modal for Prediction List -->
<div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="predictionModalLabel">
                    <i class="fas fa-calendar-day me-2"></i>
                    Mga Prediksyon para sa <span id="modalDate" class="text-primary"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                 <!-- Pest Predictions -->
                <div id="pestPredictionsSection" style="display: none;">
                    <h6 class="text-success fw-bold mb-3 border-bottom pb-2">
                        <i class="fas fa-bug me-2"></i>Mga Peste (<span id="pestCount"></span>)
                    </h6>
                    <div id="pestPredictionsList" class="mb-4"></div>
                </div>
                
                 <!-- Disease Predictions -->
                <div id="diseasePredictionsSection" style="display: none;">
                    <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">
                        <i class="fas fa-virus me-2"></i>Mga Sakit (<span id="diseaseCount"></span>)
                    </h6>
                    <div id="diseasePredictionsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Isara
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Prediction Modal -->
<div class="modal fade" id="predictionDetailModal" tabindex="-1" aria-labelledby="predictionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="predictionDetailModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Detalye ng Deteksyon
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                     <!-- Image Section -->
                    <div class="col-md-5 mb-3">
                        <div class="prediction-image-container">
                            <img id="detailImage" src="" alt="Prediction image" class="img-fluid rounded shadow-sm" style="width: 100%; height: auto; max-height: 300px; object-fit: cover;">
                        </div>
                    </div>
                    
                     <!-- Details Section -->
                    <div class="col-md-7">
                         <!-- Prediction Class -->
                        <div class="mb-3">
                            <h4 id="detailClass" class="text-primary mb-2"></h4>
                            <span id="detailTypeBadge" class="badge"></span>
                            <span id="detailNewBadge" class="badge bg-danger ms-1" style="display: none;">BAGO</span>
                        </div>
                        
                         <!-- Confidence Score -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Antas ng Kumpiyansa</label>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 25px;">
                                    <div id="detailConfidenceBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span id="detailConfidenceText" class="fw-bold"></span>
                            </div>
                        </div>
                        
                         <!-- Timestamp -->
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">
                                <i class="fas fa-clock me-1"></i>Petsa at Oras
                            </label>
                            <p id="detailTime" class="mb-0"></p>
                        </div>
                        
                         <!-- Location Information -->
                         <div class="card bg-light border-0 mt-3">
                            <div class="card-body">
                                <h6 class="card-title fw-bold mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>Impormasyon ng Lokasyon
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Barangay</small>
                                        <strong id="detailFarmerBarangay">{{ farmer.barangay }}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Laki ng Sakahan</small>
                                        <strong id="detailFarmerFarmSize">{{ farmer.farm_size }} hectares</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>Bumalik
                </button>
            </div>
        </div>
    </div>
</div>

<!-- External Libraries -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
class WeatherService {
  constructor() {
    this.apiKey = '38e8d673902b4e0024dabf392ced78b4'; // Replace with your actual API key
    this.city = '{{ farmer.barangay }},PH';
    this.lat = 13.1858; // Victoria, Oriental Mindoro coordinates
    this.lon = 121.3299;
    this.updateInterval = 10 * 60 * 1000; // Update every 10 minutes
    this.init();
  }

  init() {
    this.updateWeather();
    setInterval(() => this.updateWeather(), this.updateInterval);
  }

  async updateWeather() {
    try {
      document.getElementById('weatherCard').classList.add('loading');
      
      // Get current weather
      const currentWeather = await this.getCurrentWeather();
      // Get 5-day forecast
      const forecast = await this.getForecast();
      
      this.displayCurrentWeather(currentWeather);
      this.displayForecast(forecast);
      this.displayFarmingAlert(currentWeather);
      this.updateLastUpdated();
      this.updateCompactWeather(currentWeather);
      
      document.getElementById('weatherCard').classList.remove('loading');
    } catch (error) {
      this.displayError();
      console.error('Weather update failed:', error);
    }
  }

  async getCurrentWeather() {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric&lang=en`
    );
    
    if (!response.ok) {
      throw new Error('Weather API request failed');
    }
    
    return await response.json();
  }

  async getForecast() {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/forecast?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric&lang=en`
    );
    
    if (!response.ok) {
      throw new Error('Forecast API request failed');
    }
    
    return await response.json();
  }

  displayCurrentWeather(data) {
    // Update current weather
    document.getElementById('currentTemp').textContent = `${Math.round(data.main.temp)}Â°C`;
    document.getElementById('weatherCondition').textContent = this.translateCondition(data.weather[0].description);
    document.getElementById('humidity').textContent = `${data.main.humidity}%`;
    document.getElementById('windSpeed').textContent = `${Math.round(data.wind.speed * 3.6)} km/h`;
    document.getElementById('feelsLike').textContent = `${Math.round(data.main.feels_like)}Â°C`;
    document.getElementById('pressure').textContent = `${data.main.pressure} hPa`;
    document.getElementById('visibility').textContent = `${(data.visibility / 1000).toFixed(1)}km`;
    
    // UV Index (you might need a separate API call for this, or estimate based on conditions)
    document.getElementById('uvIndex').textContent = this.estimateUVIndex(data.weather[0].main, data.dt);

    // Update weather icon
    this.updateWeatherIcon(data.weather[0].main, data.weather[0].icon);
  }

  updateCompactWeather(data) {
    document.getElementById('compactTemp').textContent = `${Math.round(data.main.temp)}Â°C`;
    document.getElementById('compactCondition').textContent = this.translateCondition(data.weather[0].description);
    
    // Update compact icon
    const compactIcon = document.querySelector('#weatherCompact i');
    compactIcon.className = this.getWeatherIcon(data.weather[0].main, data.weather[0].icon);
  }

  displayForecast(data) {
    const forecastContainer = document.getElementById('forecastContainer');
    forecastContainer.innerHTML = '';

    // Group forecast data by day (take one per day, preferably noon)
    const dailyForecasts = this.processForecastData(data.list);

    dailyForecasts.forEach((forecast, index) => {
      const forecastItem = document.createElement('div');
      forecastItem.className = 'forecast-item';
      forecastItem.style.background = 'rgba(255,255,255,0.15)';
      forecastItem.style.borderRadius = '10px';
      forecastItem.style.padding = '15px';
      forecastItem.style.margin = '10px 0';
      forecastItem.style.backdropFilter = 'blur(5px)';
      forecastItem.style.transition = 'all 0.3s ease';
      
      forecastItem.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255,255,255,0.25)';
        this.style.transform = 'translateX(5px)';
      });
      
      forecastItem.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255,255,255,0.15)';
        this.style.transform = 'translateX(0)';
      });

      const day = index === 0 ? 'Ngayon' : this.getDayName(forecast.dt);
      const icon = this.getWeatherIcon(forecast.weather[0].main);
      
      forecastItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span class="forecast-day fw-bold">${day}</span>
          <i class="${icon} fa-lg"></i>
          <span class="forecast-temp fw-bold">${Math.round(forecast.main.temp_max)}Â°/${Math.round(forecast.main.temp_min)}Â°</span>
        </div>
        <div class="text-center mt-2">
          <small>${this.translateCondition(forecast.weather[0].description)}</small>
        </div>
      `;
      
      forecastContainer.appendChild(forecastItem);
    });
  }

  displayFarmingAlert(data) {
    const alertContainer = document.getElementById('farmingAlert');
    let alertMessage = '';
    let alertClass = 'farming-alert';

    // Check for farming-relevant weather conditions
    if (data.main.humidity > 80 && data.weather[0].main.toLowerCase().includes('rain')) {
      alertMessage = 'ðŸš¨ Mataas ang humidity at umuulan - Mag-ingat sa fungal diseases!';
      alertClass += ' rain';
    } else if (data.main.temp > 32) {
      alertMessage = 'â˜€ï¸ Mainit ngayon - Siguraduhing may sapat na tubig ang mga pananim!';
      alertClass += ' heat';
    } else if (data.wind.speed > 8) {
      alertMessage = 'ðŸ’¨ Malakas ang hangin - Protektahan ang mga young plants!';
    } else if (data.main.humidity < 40) {
      alertMessage = 'ðŸŒ¾ Dry conditions - Maganda para sa harvesting!';
    }

    if (alertMessage) {
      alertContainer.innerHTML = alertMessage;
      alertContainer.className = alertClass;
      alertContainer.style.display = 'block';
      alertContainer.style.padding = '15px';
      alertContainer.style.borderRadius = '10px';
      alertContainer.style.margin = '15px';
      alertContainer.style.fontWeight = 'bold';
      
      if (alertClass.includes('rain')) {
        alertContainer.style.background = 'rgba(54, 162, 235, 0.9)';
        alertContainer.style.color = 'white';
      } else if (alertClass.includes('heat')) {
        alertContainer.style.background = 'rgba(255, 99, 132, 0.9)';
        alertContainer.style.color = 'white';
      } else {
        alertContainer.style.background = 'rgba(255, 193, 7, 0.9)';
        alertContainer.style.color = '#856404';
      }
    } else {
      alertContainer.style.display = 'none';
    }
  }

  processForecastData(forecastList) {
    const dailyData = {};
    
    forecastList.forEach(item => {
      const date = new Date(item.dt * 1000).toDateString();
      
      if (!dailyData[date]) {
        dailyData[date] = {
          ...item,
          main: {
            ...item.main,
            temp_min: item.main.temp_min,
            temp_max: item.main.temp_max
          }
        };
      } else {
        // Update min/max temperatures for the day
        dailyData[date].main.temp_min = Math.min(dailyData[date].main.temp_min, item.main.temp_min);
        dailyData[date].main.temp_max = Math.max(dailyData[date].main.temp_max, item.main.temp_max);
        
        // Prefer noon data for main weather condition
        const itemHour = new Date(item.dt * 1000).getHours();
        const currentHour = new Date(dailyData[date].dt * 1000).getHours();
        if (Math.abs(itemHour - 12) < Math.abs(currentHour - 12)) {
          dailyData[date].weather = item.weather;
          dailyData[date].main.temp = item.main.temp;
        }
      }
    });

    return Object.values(dailyData).slice(0, 5);
  }

  updateWeatherIcon(condition, iconCode) {
    const iconElement = document.querySelector('#weatherIcon i');
    iconElement.className = this.getWeatherIcon(condition, iconCode);
  }

  getWeatherIcon(condition, iconCode = '') {
    const conditionLower = condition.toLowerCase();
    
    if (conditionLower.includes('rain') || conditionLower.includes('drizzle')) {
      return 'fas fa-cloud-rain';
    } else if (conditionLower.includes('thunderstorm')) {
      return 'fas fa-bolt';
    } else if (conditionLower.includes('snow')) {
      return 'fas fa-snowflake';
    } else if (conditionLower.includes('mist') || conditionLower.includes('fog')) {
      return 'fas fa-smog';
    } else if (conditionLower.includes('cloud')) {
      return iconCode && iconCode.includes('n') ? 'fas fa-cloud-moon' : 'fas fa-cloud';
    } else if (conditionLower.includes('clear')) {
      return iconCode && iconCode.includes('n') ? 'fas fa-moon' : 'fas fa-sun';
    } else {
      return 'fas fa-cloud-sun';
    }
  }

  translateCondition(condition) {
    const translations = {
      'clear sky': 'Malinaw na langit',
      'few clouds': 'Kaunting ulap',
      'scattered clouds': 'Kalat-kalat na ulap',
      'broken clouds': 'Maulap',
      'overcast clouds': 'Napakaulap',
      'light rain': 'Maambon',
      'moderate rain': 'Umuulan',
      'heavy rain': 'Malakas na ulan',
      'very heavy rain': 'Napakalakas na ulan',
      'extreme rain': 'Sobrang lakas ng ulan',
      'freezing rain': 'Nag-freeze na ulan',
      'light intensity shower rain': 'Malakas na ambon',
      'shower rain': 'Shower ng ulan',
      'heavy intensity shower rain': 'Malakas na shower',
      'ragged shower rain': 'Hindi tuloy-tuloy na ulan',
      'thunderstorm': 'May kidlat at kulog',
      'thunderstorm with light rain': 'Kidlat at ambon',
      'thunderstorm with rain': 'Kidlat at ulan',
      'thunderstorm with heavy rain': 'Malakas na bagyo',
      'light thunderstorm': 'Malakas na kidlat',
      'heavy thunderstorm': 'Napakalakas na bagyo',
      'ragged thunderstorm': 'Hindi tuloy-tuloy na bagyo',
      'mist': 'Mahamog',
      'fog': 'Malaking hamog',
      'haze': 'Maalikabok',
      'dust': 'Maalinsangan',
      'sand': 'May buhangin sa hangin',
      'ash': 'May abo sa hangin',
      'squall': 'Malakas na hangin',
      'tornado': 'Ipu-ipo'
    };

    return translations[condition.toLowerCase()] || condition;
  }

  getDayName(timestamp) {
    const days = ['Linggo', 'Lunes', 'Martes', 'Miyerkules', 'Huwebes', 'Biyernes', 'Sabado'];
    const date = new Date(timestamp * 1000);
    return days[date.getDay()];
  }

  estimateUVIndex(condition, timestamp) {
    const hour = new Date(timestamp * 1000).getHours();
    
    // Basic UV estimation based on time and weather
    if (hour < 6 || hour > 18) return '0';
    if (condition.toLowerCase().includes('rain') || condition.toLowerCase().includes('storm')) return '1-2';
    if (condition.toLowerCase().includes('cloud')) return '3-5';
    if (condition.toLowerCase().includes('clear')) {
      if (hour >= 10 && hour <= 14) return '8-10';
      return '5-7';
    }
    return '3-5';
  }

  updateLastUpdated() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-PH', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
    document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
  }

  displayError() {
    document.getElementById('weatherCard').classList.remove('loading');
    document.getElementById('weatherCondition').innerHTML = 
      '<span class="error-message">Hindi ma-access ang weather data. Subukan ulit mamaya.</span>';
  }
}

// Alternative free weather service (if OpenWeatherMap doesn't work)
class AlternativeWeatherService {
  constructor() {
    this.init();
  }

  async init() {
    try {
      // Using wttr.in service which doesn't require API key
      const response = await fetch('https://wttr.in/Victoria,Philippines?format=j1');
      const data = await response.json();
      this.displayWeatherData(data);
    } catch (error) {
      this.displayDefaultWeather();
    }
  }

  displayWeatherData(data) {
    const current = data.current_condition[0];
    const forecast = data.weather;

    // Update current weather
    document.getElementById('currentTemp').textContent = `${current.temp_C}Â°C`;
    document.getElementById('weatherCondition').textContent = this.translateCondition(current.weatherDesc[0].value);
    document.getElementById('humidity').textContent = `${current.humidity}%`;
    document.getElementById('windSpeed').textContent = `${current.windspeedKmph} km/h`;
    document.getElementById('feelsLike').textContent = `${current.FeelsLikeC}Â°C`;
    document.getElementById('pressure').textContent = `${current.pressure} hPa`;
    document.getElementById('visibility').textContent = `${current.visibility}km`;
    document.getElementById('uvIndex').textContent = current.uvIndex || '5';

    // Update icon
    this.updateWeatherIcon(current.weatherCode);

    // Update forecast
    this.displayForecast(forecast);
    this.updateLastUpdated();
    this.updateCompactWeather(current);
  }

  updateCompactWeather(data) {
    document.getElementById('compactTemp').textContent = `${data.temp_C}Â°C`;
    document.getElementById('compactCondition').textContent = this.translateCondition(data.weatherDesc[0].value);
    
    // Update compact icon
    const compactIcon = document.querySelector('#weatherCompact i');
    compactIcon.className = this.getWeatherIconByCode(data.weatherCode);
  }

  displayForecast(forecast) {
    const forecastContainer = document.getElementById('forecastContainer');
    forecastContainer.innerHTML = '';

    forecast.slice(0, 5).forEach((day, index) => {
      const forecastItem = document.createElement('div');
      forecastItem.className = 'forecast-item';
      forecastItem.style.background = 'rgba(255,255,255,0.15)';
      forecastItem.style.borderRadius = '10px';
      forecastItem.style.padding = '15px';
      forecastItem.style.margin = '10px 0';
      forecastItem.style.backdropFilter = 'blur(5px)';
      forecastItem.style.transition = 'all 0.3s ease';
      
      forecastItem.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255,255,255,0.25)';
        this.style.transform = 'translateX(5px)';
      });
      
      forecastItem.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255,255,255,0.15)';
        this.style.transform = 'translateX(0)';
      });

      const dayName = index === 0 ? 'Ngayon' : this.getDayName(new Date(day.date));
      const condition = day.hourly[12] ? day.hourly[12].weatherDesc[0].value : day.hourly[0].weatherDesc[0].value;
      
      forecastItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span class="forecast-day fw-bold">${dayName}</span>
          <i class="${this.getWeatherIconByCode(day.hourly[12]?.weatherCode || day.hourly[0].weatherCode)} fa-lg"></i>
          <span class="forecast-temp fw-bold">${day.maxtempC}Â°/${day.mintempC}Â°</span>
        </div>
        <div class="text-center mt-2">
          <small>${this.translateCondition(condition)}</small>
        </div>
      `;
      
      forecastContainer.appendChild(forecastItem);
    });
  }

  updateWeatherIcon(weatherCode) {
    const iconElement = document.querySelector('#weatherIcon i');
    iconElement.className = this.getWeatherIconByCode(weatherCode);
  }

  getWeatherIconByCode(code) {
    // Weather icon mapping based on weather codes
    const iconMap = {
      '113': 'fas fa-sun',           // Clear/Sunny
      '116': 'fas fa-cloud-sun',     // Partly cloudy
      '119': 'fas fa-cloud',         // Cloudy
      '122': 'fas fa-cloud',         // Overcast
      '143': 'fas fa-smog',          // Mist
      '176': 'fas fa-cloud-rain',    // Patchy rain possible
      '179': 'fas fa-snowflake',     // Patchy snow possible
      '182': 'fas fa-cloud-rain',    // Patchy sleet possible
      '185': 'fas fa-cloud-rain',    // Patchy freezing drizzle possible
      '200': 'fas fa-bolt',          // Thundery outbreaks possible
      '227': 'fas fa-snowflake',     // Blowing snow
      '230': 'fas fa-snowflake',     // Blizzard
      '248': 'fas fa-smog',          // Fog
      '260': 'fas fa-smog',          // Freezing fog
      '263': 'fas fa-cloud-rain',    // Patchy light drizzle
      '266': 'fas fa-cloud-rain',    // Light drizzle
      '281': 'fas fa-cloud-rain',    // Freezing drizzle
      '284': 'fas fa-cloud-rain',    // Heavy freezing drizzle
      '293': 'fas fa-cloud-rain',    // Patchy light rain
      '296': 'fas fa-cloud-rain',    // Light rain
      '299': 'fas fa-cloud-rain',    // Moderate rain at times
      '302': 'fas fa-cloud-rain',    // Moderate rain
      '305': 'fas fa-cloud-rain',    // Heavy rain at times
      '308': 'fas fa-cloud-rain',    // Heavy rain
      '311': 'fas fa-cloud-rain',    // Light freezing rain
      '314': 'fas fa-cloud-rain',    // Moderate or heavy freezing rain
      '317': 'fas fa-cloud-rain',    // Light sleet
      '320': 'fas fa-cloud-rain',    // Moderate or heavy sleet
      '323': 'fas fa-snowflake',     // Patchy light snow
      '326': 'fas fa-snowflake',     // Light snow
      '329': 'fas fa-snowflake',     // Patchy moderate snow
      '332': 'fas fa-snowflake',     // Moderate snow
      '335': 'fas fa-snowflake',     // Patchy heavy snow
      '338': 'fas fa-snowflake',     // Heavy snow
      '350': 'fas fa-cloud-rain',    // Ice pellets
      '353': 'fas fa-cloud-rain',    // Light rain shower
      '356': 'fas fa-cloud-rain',    // Moderate or heavy rain shower
      '359': 'fas fa-cloud-rain',    // Torrential rain shower
      '362': 'fas fa-cloud-rain',    // Light sleet showers
      '365': 'fas fa-cloud-rain',    // Moderate or heavy sleet showers
      '368': 'fas fa-snowflake',     // Light snow showers
      '371': 'fas fa-snowflake',     // Moderate or heavy snow showers
      '374': 'fas fa-cloud-rain',    // Light showers of ice pellets
      '377': 'fas fa-cloud-rain',    // Moderate or heavy showers of ice pellets
      '386': 'fas fa-bolt',          // Patchy light rain with thunder
      '389': 'fas fa-bolt',          // Moderate or heavy rain with thunder
      '392': 'fas fa-bolt',          // Patchy light snow with thunder
      '395': 'fas fa-bolt'           // Moderate or heavy snow with thunder
    };

    return iconMap[code] || 'fas fa-cloud-sun';
  }

  translateCondition(condition) {
    const translations = {
      'Clear': 'Malinaw',
      'Sunny': 'Maaraw',
      'Partly cloudy': 'Bahagyang maulap',
      'Cloudy': 'Maulap',
      'Overcast': 'Napakaulap',
      'Mist': 'Mahamog',
      'Patchy rain possible': 'Posibleng umuulan',
      'Patchy snow possible': 'Posibleng mag-snow',
      'Patchy sleet possible': 'Posibleng sleet',
      'Patchy freezing drizzle possible': 'Posibleng freezing drizzle',
      'Thundery outbreaks possible': 'Posibleng may kidlat',
      'Blowing snow': 'Umuulong snow',
      'Blizzard': 'Blizzard',
      'Fog': 'Malaking hamog',
      'Freezing fog': 'Nag-freeze na hamog',
      'Patchy light drizzle': 'Bahagyang ambon',
      'Light drizzle': 'Ambon',
      'Freezing drizzle': 'Nag-freeze na ambon',
      'Heavy freezing drizzle': 'Malakas na freezing drizzle',
      'Patchy light rain': 'Bahagyang ulan',
      'Light rain': 'Maambon',
      'Moderate rain at times': 'Katamtamang ulan',
      'Moderate rain': 'Katamtamang ulan',
      'Heavy rain at times': 'Malakas na ulan',
      'Heavy rain': 'Malakas na ulan',
      'Light freezing rain': 'Maambon na nag-freeze',
      'Moderate or heavy freezing rain': 'Katamtaman o malakas na freezing rain',
      'Light sleet': 'Maambon na sleet',
      'Moderate or heavy sleet': 'Katamtaman o malakas na sleet',
      'Patchy light snow': 'Bahagyang snow',
      'Light snow': 'Maambon na snow',
      'Patchy moderate snow': 'Bahagyang katamtamang snow',
      'Moderate snow': 'Katamtamang snow',
      'Patchy heavy snow': 'Bahagyang malakas na snow',
      'Heavy snow': 'Malakas na snow',
      'Ice pellets': 'Mga yelong butil',
      'Light rain shower': 'Maambon na shower',
      'Moderate or heavy rain shower': 'Katamtaman o malakas na shower',
      'Torrential rain shower': 'Napakalakas na shower',
      'Light sleet showers': 'Maambon na sleet shower',
      'Moderate or heavy sleet showers': 'Katamtaman o malakas na sleet shower',
      'Light snow showers': 'Maambon na snow shower',
      'Moderate or heavy snow showers': 'Katamtaman o malakas na snow shower',
      'Light showers of ice pellets': 'Maambon na ice pellets',
      'Moderate or heavy showers of ice pellets': 'Katamtaman o malakas na ice pellets',
      'Patchy light rain with thunder': 'Bahagyang ulan na may kidlat',
      'Moderate or heavy rain with thunder': 'Katamtaman o malakas na ulan na may kidlat',
      'Patchy light snow with thunder': 'Bahagyang snow na may kidlat',
      'Moderate or heavy snow with thunder': 'Katamtaman o malakas na snow na may kidlat'
    };

    return translations[condition] || condition;
  }

  getDayName(date) {
    const days = ['Linggo', 'Lunes', 'Martes', 'Miyerkules', 'Huwebes', 'Biyernes', 'Sabado'];
    return days[date.getDay()];
  }

  updateLastUpdated() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-PH', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
    document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
  }

  displayDefaultWeather() {
    // Display typical weather for Victoria, Oriental Mindoro
    document.getElementById('currentTemp').textContent = '27Â°C';
    document.getElementById('weatherCondition').textContent = 'Tropical na panahon';
    document.getElementById('humidity').textContent = '85%';
    document.getElementById('windSpeed').textContent = '12 km/h';
    document.getElementById('feelsLike').textContent = '30Â°C';
    document.getElementById('pressure').textContent = '1012 hPa';
    document.getElementById('visibility').textContent = '10km';
    document.getElementById('uvIndex').textContent = '7-8';
    this.updateLastUpdated();
    
    // Update compact weather
    document.getElementById('compactTemp').textContent = '27Â°C';
    document.getElementById('compactCondition').textContent = 'Tropical na panahon';
  }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize weather service when page loads
    // Try primary weather service first
    const weatherService = new WeatherService();
    
    // Fallback to alternative service after 5 seconds if primary fails
    setTimeout(() => {
        if (document.getElementById('currentTemp').textContent === '--Â°C') {
            console.log('Using alternative weather service...');
            new AlternativeWeatherService();
        }
    }, 5000);

    // Initialize Bootstrap tooltip
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Weather modal button event
    document.getElementById('weatherModalBtn').addEventListener('click', function() {
        const weatherModal = new bootstrap.Modal(document.getElementById('weatherModal'));
        weatherModal.show();
    });

    // Charts
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [
                {
                    label: 'Mga Peste',
                    data: {{ monthly_pests|safe }},
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Mga Sakit',
                    data: {{ monthly_diseases|safe }},
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    const summaryCtx = document.getElementById('summaryChart').getContext('2d');
    new Chart(summaryCtx, {
        type: 'doughnut',
        data: {
            labels: ['Peste', 'Sakit'],
            datasets: [{
                data: [{{ pest_count }}, {{ disease_count }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            cutout: '70%'
        }
    });

    // Enhanced Calendar with Admin-style Features
    try {
        let eventsData = [];
        try {
            eventsData = {{ calendar_events|safe }};
            console.log("Calendar events loaded:", eventsData);
        } catch (error) {
            console.error("Failed to parse calendar events:", error);
            eventsData = [];
        }
        
        const calendarEl = document.getElementById('calendar');
        
        if (!calendarEl) {
            console.error("Calendar element not found!");
            return;
        }
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: eventsData,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            height: 600,
            eventDidMount: function(info) {
                // Add "new" indicator dot if there are new predictions
                if (info.event.extendedProps && info.event.extendedProps.has_new) {
                    const dotEl = document.createElement('span');
                    dotEl.innerHTML = ' <span style="display: inline-block; width: 8px; height: 8px; background-color: #ff0000; border-radius: 50%; margin-left: 4px; animation: pulse 1.5s infinite;"></span>';
                    info.el.querySelector('.fc-event-title').appendChild(dotEl);
                }
                
                info.el.style.cursor = 'pointer';
            },
            eventClick: function(info) {
                const props = info.event.extendedProps || {};
                const eventDate = new Date(info.event.start);
                const formattedDate = eventDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                document.getElementById('modalDate').textContent = formattedDate;
                
                // Show pest predictions
                if (props.pest_count > 0) {
                    document.getElementById('pestPredictionsSection').style.display = 'block';
                    document.getElementById('pestCount').textContent = props.pest_count;
                    
                    const pestPredictions = props.pest_predictions || [];
                    const sortedPest = [...pestPredictions].sort((a, b) => b.id - a.id);
                    
                    let pestHTML = '';
                    sortedPest.forEach(pred => {
                        const newBadge = pred.is_new ? '<span class="badge bg-danger ms-2 pulse-badge">BAGO</span>' : '';
                        const confidenceColor = pred.confidence >= 80 ? 'success' : pred.confidence >= 50 ? 'warning' : 'danger';
                        
                        pestHTML += `
                            <div class="card mb-3 prediction-card shadow-sm hover-shadow" style="cursor: pointer;" onclick='showPredictionDetail(${JSON.stringify(pred).replace(/'/g, "&#39;")})'>
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        ${pred.image_url ? `
                                            <div class="col-md-3">
                                                <img src="${pred.image_url}" class="img-fluid rounded shadow-sm" alt="Prediction image" style="height: 100px; width: 100%; object-fit: cover;">
                                            </div>
                                        ` : ''}
                                        <div class="${pred.image_url ? 'col-md-6' : 'col-md-9'}">
                                            <h6 class="mb-2">
                                                <i class="fas fa-bug text-success me-2"></i>${pred.class} ${newBadge}
                                            </h6>
                                            <div class="mb-2">
                                                <small class="text-muted d-block mb-1">Antas ng Kumpiyansa</small>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-${confidenceColor}" role="progressbar" style="width: ${pred.confidence}%" aria-valuenow="${pred.confidence}" aria-valuemin="0" aria-valuemax="100">
                                                        ${pred.confidence.toFixed(1)}%
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="mb-1 text-muted small">
                                                <i class="fas fa-clock me-1"></i>${pred.time}
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="location-info-preview p-2 bg-light rounded">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-map-marker-alt me-1"></i>Lokasyon</small>
                                                <strong class="d-block small">{{ farmer.barangay }}</strong>
                                                <small class="text-muted d-block mt-1">{{ farmer.farm_size }} hectares</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('pestPredictionsList').innerHTML = pestHTML;
                } else {
                    document.getElementById('pestPredictionsSection').style.display = 'none';
                }
                
                // Show disease predictions
                if (props.disease_count > 0) {
                    document.getElementById('diseasePredictionsSection').style.display = 'block';
                    document.getElementById('diseaseCount').textContent = props.disease_count;
                    
                    const diseasePredictions = props.disease_predictions || [];
                    const sortedDisease = [...diseasePredictions].sort((a, b) => b.id - a.id);
                    
                    let diseaseHTML = '';
                    sortedDisease.forEach(pred => {
                        const newBadge = pred.is_new ? '<span class="badge bg-danger ms-2 pulse-badge">BAGO</span>' : '';
                        const confidenceColor = pred.confidence >= 80 ? 'success' : pred.confidence >= 50 ? 'warning' : 'danger';
                        
                        diseaseHTML += `
                            <div class="card mb-3 prediction-card shadow-sm hover-shadow" style="cursor: pointer;" onclick='showPredictionDetail(${JSON.stringify(pred).replace(/'/g, "&#39;")})'>
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        ${pred.image_url ? `
                                            <div class="col-md-3">
                                                <img src="${pred.image_url}" class="img-fluid rounded shadow-sm" alt="Prediction image" style="height: 100px; width: 100%; object-fit: cover;">
                                            </div>
                                        ` : ''}
                                        <div class="${pred.image_url ? 'col-md-6' : 'col-md-9'}">
                                            <h6 class="mb-2">
                                                <i class="fas fa-virus text-danger me-2"></i>${pred.class} ${newBadge}
                                            </h6>
                                            <div class="mb-2">
                                                <small class="text-muted d-block mb-1">Antas ng Kumpiyansa</small>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-${confidenceColor}" role="progressbar" style="width: ${pred.confidence}%" aria-valuenow="${pred.confidence}" aria-valuemin="0" aria-valuemax="100">
                                                        ${pred.confidence.toFixed(1)}%
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="mb-1 text-muted small">
                                                <i class="fas fa-clock me-1"></i>${pred.time}
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="location-info-preview p-2 bg-light rounded">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-map-marker-alt me-1"></i>Lokasyon</small>
                                                <strong class="d-block small">{{ farmer.barangay }}</strong>
                                                <small class="text-muted d-block mt-1">{{ farmer.farm_size }} hectares</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('diseasePredictionsList').innerHTML = diseaseHTML;
                } else {
                    document.getElementById('diseasePredictionsSection').style.display = 'none';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
                modal.show();
            }
        });
        
        calendar.render();
        console.log("Calendar render method called");
        
    } catch (err) {
        console.error("Error in calendar initialization:", err);
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            calendarEl.innerHTML = '<div class="alert alert-danger">Failed to load calendar: ' + err.message + '</div>';
        }
    }

    // Flipping Text Animation
    const phrases = [
        "Malusog na pananim, masaganang ani! ðŸŒ¾",
        "Alamin ang peste at sakit! ðŸ›",
        "Kumonsulta sa mga eksperto! ðŸ‘¨â€ðŸŒ¾",
        "Gamitin ang teknolohiya! ðŸ“±",
        "Masaganang ani sa VictoreÃ±os! ðŸŽ¯"
    ];
    let index = 0;
    const flippingText = document.getElementById('flipping-text');

    setInterval(() => {
        index = (index + 1) % phrases.length;
        flippingText.style.opacity = 0;
        setTimeout(() => {
            flippingText.textContent = phrases[index];
            flippingText.style.opacity = 1;
        }, 500);
    }, 3000);
});

// Global function for showing prediction details
function showPredictionDetail(prediction) {
    // Set image
    document.getElementById('detailImage').src = prediction.image_url || '/static/images/placeholder.jpg';
    
    // Set class name
    document.getElementById('detailClass').textContent = prediction.class;
    
    // Set type badge
    const typeBadge = document.getElementById('detailTypeBadge');
    if (prediction.type === 'pest') {
        typeBadge.textContent = 'Peste';
        typeBadge.className = 'badge bg-success';
    } else {
        typeBadge.textContent = 'Sakit';
        typeBadge.className = 'badge bg-danger';
    }
    
    // Show/hide NEW badge
    const newBadge = document.getElementById('detailNewBadge');
    newBadge.style.display = prediction.is_new ? 'inline-block' : 'none';
    
    // Set confidence with color coding
    const confidence = prediction.confidence;
    const confidenceBar = document.getElementById('detailConfidenceBar');
    const confidenceText = document.getElementById('detailConfidenceText');
    
    confidenceBar.style.width = confidence + '%';
    confidenceText.textContent = confidence.toFixed(1) + '%';
    
    if (confidence >= 80) {
        confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-success';
    } else if (confidence >= 50) {
        confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
    } else {
        confidenceBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-danger';
    }
    
    // Set timestamp
    document.getElementById('detailTime').textContent = prediction.time;
    
    // Show the detail modal
    const detailModal = new bootstrap.Modal(document.getElementById('predictionDetailModal'));
    detailModal.show();
}

// Make function available globally
window.showPredictionDetail = showPredictionDetail;

function showUploadModal() {
    // Redirect to upload page or show upload modal
    window.location.href = '/farmer/upload/';
}

// Manual refresh function
function refreshWeather() {
    document.getElementById('weatherCard').classList.add('loading');
    new WeatherService();
}
</script>

<style>
.flipping-text {
    font-size: 1.5rem;
    font-weight: bold;
    color: #28a745;
    display: inline-block;
    position: relative;
    animation: fadeIn 1s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
}

.pulse-badge {
    animation: pulse 1.5s infinite;
}

.prediction-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.prediction-card:hover {
    transform: translateY(-2px);
    border-left-color: #007bff;
}

.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.location-info-preview {
    transition: all 0.2s ease;
}

.prediction-card:hover .location-info-preview {
    background-color: #e3f2fd !important;
}

.modal-xl {
    max-width: 1200px;
}

.prediction-image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
}

.prediction-image-container img {
    transition: transform 0.3s ease;
}

.prediction-image-container:hover img {
    transform: scale(1.05);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

/* Compact Weather Styles */
.weather-compact {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 12px;
    border-radius: 10px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
}

.weather-compact:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.weather-compact i {
    color: #ffeb3b;
}

.weather-compact .fw-bold {
    font-size: 1.1rem;
    margin-bottom: 2px;
}

.weather-compact small {
    font-size: 0.8rem;
    opacity: 0.9;
}

/* Weather Modal Styles */
.weather-card {
  background: linear-gradient(135deg, rgba(46, 125, 50, 0.95), rgba(76, 175, 80, 0.95));
  border-radius: 0;
  box-shadow: none;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  position: relative;
  width: 100%;
  z-index: 10;
}

.weather-header {
  text-align: center;
  padding: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.weather-icon {
  font-size: 4rem;
  margin-bottom: 15px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.temperature {
  font-size: 3rem;
  font-weight: bold;
  margin: 0;
}

.weather-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  padding: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.weather-item {
  text-align: center;
  padding: 15px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  transition: all 0.3s ease;
}

.weather-item:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-2px);
}

.weather-item i {
  display: block;
  margin-bottom: 10px;
  color: rgba(255,255,255,0.9);
  font-size: 1.5rem;
}

.forecast-section {
  padding: 20px;
}

.forecast-item {
  background: rgba(255,255,255,0.15);
  border-radius: 10px;
  padding: 15px;
  margin: 10px 0;
  backdrop-filter: blur(5px);
  transition: all 0.3s ease;
}

.forecast-item:hover {
  background: rgba(255,255,255,0.25);
  transform: translateX(5px);
}

.forecast-day {
  font-weight: bold;
}

.forecast-temp {
  font-size: 1.1rem;
  margin: 5px 0;
  font-weight: bold;
}

.loading {
  opacity: 0.7;
  pointer-events: none;
}

.error-message {
  color: #ffcdd2;
  font-size: 0.9rem;
  text-align: center;
  padding: 10px;
}

.last-updated {
  font-size: 0.8rem;
  opacity: 0.8;
  border-top: 1px solid rgba(255,255,255,0.2);
}

/* Farming alerts */
.farming-alert {
  background: rgba(255, 193, 7, 0.9);
  color: #856404;
  padding: 15px;
  border-radius: 10px;
  margin: 15px;
  font-size: 0.9rem;
  font-weight: bold;
}

.farming-alert.rain {
  background: rgba(54, 162, 235, 0.9);
  color: white;
}

.farming-alert.heat {
  background: rgba(255, 99, 132, 0.9);
  color: white;
}

/* Modal specific styles */
#weatherModal .modal-content {
    border-radius: 15px;
    overflow: hidden;
}

#weatherModal .modal-header {
    border-bottom: none;
}

#weatherModal .btn-close {
    filter: invert(1);
}
</style>
{% endblock %}