{% extends 'farmer/base_farmer.html' %}

{% block content %}
<div class="container mt-4">
    {% if expert %}
    <div class="row">
        <!-- Left Column: Expert Profile Card -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-lg border-0 rounded-4 profile-card sticky-top" style="top: 20px;">
                <div class="card-body text-center p-4">
                    <!-- Profile Picture -->
                    <div class="profile-picture-container mb-4">
                        {% if expert.profile_picture %}
                            <img src="{{ expert.profile_picture }}" alt="Profile Picture" 
                                 class="img-fluid rounded-circle profile-img border border-4 border-success">
                        {% else %}
                            <div class="rounded-circle profile-img-placeholder bg-secondary d-flex align-items-center justify-content-center border border-4 border-success">
                                <i class="fas fa-user fa-4x text-white"></i>
                            </div>
                        {% endif %}
                        
                        <!-- Verified Badge -->
                        <span class="verified-badge position-absolute">
                            <i class="fas fa-check-circle"></i>
                        </span>
                    </div>

                    <!-- Expert Name -->
                    <h2 class="fw-bold mb-2 text-primary">
                        {{ expert.first_name }}{% if expert.middle_name %} {{ expert.middle_name }}{% endif %} {{ expert.last_name }}
                    </h2>
                    
                    <!-- Badge -->
                    <span class="badge bg-success px-3 py-2 mb-3">
                        <i class="fas fa-check-circle me-1"></i> Aprubadong Eksperto
                    </span>

                    <!-- Quick Stats -->
                    <div class="row g-3 mt-3">
                        <div class="col-6">
                            <div class="stat-card p-3 bg-light rounded-3">
                                <h4 class="mb-0 text-primary fw-bold">{{ expert_posts_count }}</h4>
                                <small class="text-muted">Mga Post</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card p-3 bg-light rounded-3">
                                <h4 class="mb-0 text-success fw-bold">{{ solution_count }}</h4>
                                <small class="text-muted">Mga Solusyon</small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 mt-4">
                        <!-- Message Button -->
                        {% if has_existing_chat %}
                            <a href="{% url 'chat_detail' expert.id %}" class="btn btn-success btn-lg">
                                <i class="fas fa-comments me-2"></i>Mag-message
                            </a>
                        {% else %}
                            <a href="{% url 'send_message' expert.id %}" class="btn btn-success btn-lg">
                                <i class="fas fa-comment-dots me-2"></i>Simulan ang Chat
                            </a>
                        {% endif %}
                        
                        <!-- Contact Buttons -->
                        <div class="btn-group w-100" role="group">
                            {% if expert.phone_number %}
                            <a href="tel:{{ expert.phone_number }}" class="btn btn-outline-primary">
                                <i class="fas fa-phone-alt"></i>
                            </a>
                            {% endif %}
                            {% if expert.email %}
                            <a href="mailto:{{ expert.email }}" class="btn btn-outline-info">
                                <i class="fas fa-envelope"></i>
                            </a>
                            {% endif %}
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Expert Details & Posts -->
        <div class="col-lg-8">
            <!-- Expert Information Card -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h4 class="fw-bold mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>Impormasyon ng Eksperto
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Professional Information -->
                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-user-tie text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Posisyon</h6>
                                        <p class="mb-0 fw-bold">{{ expert.position|default:"Agricultural Expert" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-id-card text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Lisensya</h6>
                                        <p class="mb-0 fw-bold">{{ expert.license_number }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-envelope text-info fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Email</h6>
                                        {% if expert.email %}
                                            <a href="mailto:{{ expert.email }}" class="mb-0 fw-bold text-decoration-none">
                                                {{ expert.email }}
                                            </a>
                                        {% else %}
                                            <p class="mb-0 fw-bold text-muted">Hindi Available</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-phone text-danger fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Telepono</h6>
                                        {% if expert.phone_number %}
                                            <a href="tel:{{ expert.phone_number }}" class="mb-0 fw-bold text-decoration-none">
                                                {{ expert.phone_number }}
                                            </a>
                                        {% else %}
                                            <p class="mb-0 fw-bold text-muted">Hindi Available</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Information -->
                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-map-marker-alt text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Barangay</h6>
                                        <p class="mb-0 fw-bold">{{ expert.barangay }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expertise Areas -->
                        <div class="col-md-6">
                            <div class="info-item p-3 bg-light rounded-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-container me-3">
                                        <i class="fas fa-seedling text-success fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 text-muted">Espesyalisasyon</h6>
                                        <p class="mb-0 fw-bold">Agrikultura, Peste, Sakit ng Tanim</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About Section -->
                    {% if expert.bio %}
                    <div class="mt-4 pt-3 border-top">
                        <h5 class="fw-bold mb-3">Tungkol sa Eksperto</h5>
                        <div class="bg-light p-3 rounded-3">
                            <p class="mb-0">{{ expert.bio|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Expert's Posts Section -->
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h4 class="fw-bold mb-0">
                        <i class="fas fa-newspaper text-success me-2"></i>Mga Post ng Eksperto
                    </h4>
                    <span class="badge bg-success px-3 py-2">{{ expert_posts_count }} Posts</span>
                </div>
                <div class="card-body">
                    {% if expert_posts %}
                    <div class="row g-4">
                        {% for post in expert_posts %}
                        <div class="col-12">
                            <div class="post-card p-3 border rounded-3 bg-white">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="me-3">
                                        {% if expert.profile_picture %}
                                            <img src="{{ expert.profile_picture }}" alt="Profile" 
                                                 class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                                 style="width: 50px; height: 50px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">{{ post.title }}</h6>
                                        <small class="text-muted">{{ post.created_at|date:"M d, Y • g:i A" }}</small>
                                        {% if post.solution_comment %}
                                            <span class="badge bg-success ms-2">
                                                <i class="fas fa-check me-1"></i>Solved
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <p class="post-excerpt mb-3">{{ post.caption|truncatewords:50 }}</p>
                                
                                <!-- Post Stats -->
                                <div class="d-flex justify-content-between align-items-center border-top pt-2">
                                    <div class="post-stats">
                                        <span class="text-muted me-3">
                                            <i class="far fa-comment me-1"></i>{{ post.comment_count }}
                                        </span>
                                        {% if post.upvote_count %}
                                        <span class="text-muted">
                                            <i class="fas fa-thumbs-up me-1"></i>{{ post.upvote_count }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'view_post' post.id %}" class="btn btn-sm btn-outline-primary">
                                        Basahin ang Buong Post
                                        <i class="fas fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- View All Posts Link -->
                    {% if expert_posts_count > 5 %}
                    <div class="text-center mt-4">
                        <a href="{% url 'farmer_experts' %}?expert={{ expert.id }}" class="btn btn-outline-success">
                            <i class="fas fa-list me-1"></i>Tingnan Lahat ng Posts
                        </a>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-graduation-cap fa-3x text-secondary mb-3"></i>
                        <p class="text-muted">Walang mga post ang ekspertong ito sa ngayon.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Back Button -->
            <div class="mt-4">
                <a href="{% url 'farmer_experts' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Bumalik sa Listahan ng mga Eksperto
                </a>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">
                        <i class="fas fa-share-alt me-2"></i>I-share ang Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <p>I-share ang profile ng eksperto sa ibang magsasaka</p>
                    </div>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-primary share-btn" onclick="shareViaFacebook()">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="btn btn-outline-info share-btn" onclick="shareViaTwitter()">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="btn btn-outline-success share-btn" onclick="shareViaWhatsApp()">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="btn btn-outline-secondary share-btn" onclick="copyProfileLink()">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Isara</button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Error State -->
    <div class="row justify-content-center">
        <div class="col-md-6 text-center py-5">
            <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
            <h3 class="fw-bold text-danger mb-3">Hindi Mahanap ang Eksperto</h3>
            <p class="text-muted mb-4">Ang hinahanap mong eksperto ay hindi na available o hindi umiiral.</p>
            <a href="{% url 'farmer_experts' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Bumalik sa Listahan ng mga Eksperto
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Custom Styles */
.profile-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.profile-img {
    width: 180px;
    height: 180px;
    object-fit: cover;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.profile-img-placeholder {
    width: 180px;
    height: 180px;
    margin: 0 auto;
}

.profile-picture-container {
    position: relative;
    display: inline-block;
}

.verified-badge {
    position: absolute;
    bottom: 20px;
    right: calc(50% - 90px - 10px);
    background: #28a745;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 4px solid white;
    box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
}

.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.info-item {
    transition: all 0.3s ease;
    border: 1px solid transparent;
    height: 100%;
}

.info-item:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.icon-container {
    width: 50px;
    height: 50px;
    background: rgba(0, 123, 255, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.post-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.post-card:hover {
    border-color: #007bff;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.post-excerpt {
    line-height: 1.6;
    color: #495057;
}

.share-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    transition: all 0.3s ease;
}

.share-btn:hover {
    transform: scale(1.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .profile-img, .profile-img-placeholder {
        width: 140px;
        height: 140px;
    }
    
    .verified-badge {
        width: 35px;
        height: 35px;
        right: calc(50% - 70px - 8px);
    }
    
    .stat-card h4 {
        font-size: 1.2rem;
    }
    
    .info-item {
        padding: 15px !important;
    }
    
    .icon-container {
        width: 40px;
        height: 40px;
    }
}

@media (max-width: 576px) {
    .btn-group .btn {
        padding: 0.5rem;
    }
    
    .post-card {
        padding: 15px !important;
    }
}
</style>

<script>
// Share functionality
function shareViaFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent("Tingnan ang ekspertong ito sa AgriExpert!");
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank');
}

function shareViaTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent("Tingnan ang kapaki-pakinabang na ekspertong ito sa AgriExpert!");
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareViaWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent("Tingnan ang ekspertong ito sa AgriExpert: ");
    window.open(`https://wa.me/?text=${text}${url}`, '_blank');
}

function copyProfileLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        // Show toast notification
        showToast('✅ Kopyado ang link!', 'success');
    }).catch(err => {
        showToast('❌ Hindi makopya ang link', 'danger');
    });
}

function showToast(message, type) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to container
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}